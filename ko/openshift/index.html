<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>The Documentation Openshift - Dokyung&#39;s DevOoOps</title><meta name="Description" content="Opshift Install Guide"><meta property="og:title" content="The Documentation Openshift" />
<meta property="og:description" content="Opshift Install Guide" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://huntedhappy.github.io/ko/openshift/" /><meta property="og:image" content="https://huntedhappy.github.io/ko/openshift/openshift.jpg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-13T15:48:11+09:00" />
<meta property="article:modified_time" content="2022-03-09T19:08:05+09:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://huntedhappy.github.io/ko/openshift/openshift.jpg"/>
<meta name="twitter:title" content="The Documentation Openshift"/>
<meta name="twitter:description" content="Opshift Install Guide"/>
<meta name="application-name" content="Dokyung&#39;s DevOoOps">
<meta name="apple-mobile-web-app-title" content="Dokyung&#39;s DevOoOps"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://huntedhappy.github.io/ko/openshift/" /><link rel="prev" href="https://huntedhappy.github.io/ko/eks/" /><link rel="next" href="https://huntedhappy.github.io/ko/nap/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "The Documentation Openshift",
        "inLanguage": "ko",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/huntedhappy.github.io\/ko\/openshift\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/huntedhappy.github.io\/ko\/openshift\/openshift.jpg",
                            "width":  720 ,
                            "height":  406 
                        }],"genre": "posts","keywords": "openshift, k8s, devops, dk, dokyung, ldap연동, openshift ldap","wordcount":  2672 ,
        "url": "https:\/\/huntedhappy.github.io\/ko\/openshift\/","datePublished": "2022-01-13T15:48:11+09:00","dateModified": "2022-03-09T19:08:05+09:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Dokyung"},"author": {
                "@type": "Person",
                "name": "Dokyung"
            },"description": "Opshift Install Guide"
    }
    </script></head>
    <body header-desktop="auto" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/ko/" title="Dokyung&#39;s DevOoOps"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/ko/posts/"> Posts </a><a class="menu-item" href="/ko/tags/"> Tags </a><a class="menu-item" href="/ko/categories/"> Categories </a><a class="menu-item" href="/ko/categories/documentation/"> Docs </a><a class="menu-item" href="/ko/about/"> About </a><a class="menu-item" href="https://github.com/huntedhappy/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Select Language">Korean<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/ko/openshift/" selected>Korean</option><option value="/openshift/">한국어</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/ko/" title="Dokyung&#39;s DevOoOps"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/ko/posts/" title="">Posts</a><a class="menu-item" href="/ko/tags/" title="">Tags</a><a class="menu-item" href="/ko/categories/" title="">Categories</a><a class="menu-item" href="/ko/categories/documentation/" title="">Docs</a><a class="menu-item" href="/ko/about/" title="">About</a><a class="menu-item" href="https://github.com/huntedhappy/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language">Korean<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/ko/openshift/" selected>Korean</option><option value="/openshift/">한국어</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">The Documentation Openshift</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://huntedhappy.tistory.com" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Dokyung</a></span>&nbsp;<span class="post-category">included in <a href="/ko/categories/documentation/"><i class="far fa-folder fa-fw"></i>Documentation</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-01-13">2022-01-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2672 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;13 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/ko/openshift/openshift.jpg"
        data-srcset="/ko/openshift/openshift.jpg, /ko/openshift/openshift.jpg 1.5x, /ko/openshift/openshift.jpg 2x"
        data-sizes="auto"
        alt="/ko/openshift/openshift.jpg"
        title="Opshift Install Guide" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-openshift">1. Openshift</a></li>
    <li><a href="#2-사전구성">2. 사전구성</a>
      <ul>
        <li><a href="#21-dns-구성">2.1. DNS 구성</a></li>
        <li><a href="#22-dhcp-구성">2.2. DHCP 구성</a></li>
      </ul>
    </li>
    <li><a href="#3-파일-다운로드">3. 파일 다운로드</a></li>
    <li><a href="#4-vcenter-ssh-thumbprint-얻기">4. vCenter SSH thumbprint 얻기</a></li>
    <li><a href="#5-temp-image">5. Temp Image</a>
      <ul>
        <li><a href="#51-temp-구성">5.1. Temp 구성</a></li>
      </ul>
    </li>
    <li><a href="#6-oc-install">6. OC Install</a></li>
    <li><a href="#7-nginx">7. NGINX</a></li>
    <li><a href="#8-temp-이미지로-vm-구성">8. Temp 이미지로 VM 구성</a></li>
    <li><a href="#9-l4-구성">9. L4 구성</a>
      <ul>
        <li><a href="#91-nsxt-l4-구성">9.1. NSXT L4 구성</a></li>
        <li><a href="#92-nginx-l4-구성">9.2. NGINX L4 구성</a></li>
      </ul>
    </li>
    <li><a href="#10-완료-후-확인">10. 완료 후 확인</a></li>
    <li><a href="#11-new-worker-node-add">11. New Worker Node Add</a></li>
    <li><a href="#12-계정">12. 계정</a>
      <ul>
        <li><a href="#121-local-계정-생성">12.1. Local 계정 생성</a></li>
        <li><a href="#122-ad-연동">12.2. AD 연동</a></li>
        <li><a href="#123-수동-group-sync">12.3. 수동 GROUP-SYNC</a></li>
        <li><a href="#124-cronjob-group-sync">12.4 CronJob Group-Sync</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="1-openshift">1. Openshift</h2>
<p><code>오픈시프트 오리진(OpenShift Origin)</code>은 오픈시프트 온라인, 오픈시프트 데디케이티드, 오픈시프트 컨테이너 플랫폼에 사용되는 업스트림 커뮤니티 프로젝트이다. 도커 컨테이너 패키징 코어와 쿠버네티스 컨테이너 클러스터 관리 기능을 기반에 두고 개발된 오리진은 애플리케이션 수명 관리 기능과 데브옵스 도구를 통해 증강된다. 오리진은 오픈 소스 애플리케이션 컨테이너 플랫폼을 제공한다. 오리진 프로젝트의 모든 소스 코드는 깃허브에서 아파치 라이선스 (버전 2.0)을 통해 이용이 가능하다.[4]</p>
<p><code>오픈시프트 온라인(OpenShift Online)</code>은 레드햇의 퍼블릭 클라우드 애플리케이션 개발 및 호스팅 서비스이다. 온라인은 오리진 프로젝트 소스 코드의 버전 2를 제공하였으며, 아파치 라이선스 버전 2.0 하에서 이용이 가능하다.[5] 온라인은 리소스 할당 기어(gear) 하에서 구동되는 미리 빌드된 카트리지를 통해 다양한 언어, 프레임워크 데이터베이스를 지원한다. 개발자들은 오픈시프트 카트리지 API를 통해 다른 언어, 데이터베이스, 구성 요소를 추가할 수 있다.[6] 오픈시프트 3의 선호로 사용이 권장되지 않는다(deprecated).</p>
<p><code>오픈시프트 데디케이티드(OpenShift Dedicated)</code>는 레드햇의 매니지드 프라이빗 클러스터 기능으로, 도커가 제공하는 애플리케이션 컨테이너의 코어를 기반으로 빌드되며 레드햇 엔터프라이즈 리눅스의 토대 위에 쿠버네티스가 제공하는 오케스트레이션 및 관리가 포함되어 있다. 아마존 웹 서비스(AWS)와 구글 클라우드 플랫폼(GCP) 마켓플레이스를 통해 이용이 가능하다.</p>
<p><code>오픈시프트 컨테이너 플랫폼(OpenShift Container Platform)</code>은 레드햇의 사내(on-premises) 프라이빗 PaaS 제품으로, 도커가 제공하는 애플리케이션 컨테이너의 코어를 기반으로 빌드되며 레드햇 엔터프라이즈 리눅스의 토대 위에 쿠버네티스가 제공하는 오케스트레이션 및 관리가 포함되어 있다.</p>
<p>참고문헌  <a href="https://ko.wikipedia.org/wiki/%EC%98%A4%ED%94%88%EC%8B%9C%ED%94%84%ED%8A%B8" target="_blank" rel="noopener noreffer"><i class="fas fa-link"></i> Openshift </a></p>
<h2 id="2-사전구성">2. 사전구성</h2>
<h3 id="21-dns-구성">2.1. DNS 구성</h3>
<table>
<thead>
<tr>
<th>Common</th>
<th>Component Name</th>
<th>Cluster Name</th>
<th>BaseDomain</th>
<th>A Record</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>api</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.254</td>
</tr>
<tr>
<td></td>
<td>api-int</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.254</td>
</tr>
<tr>
<td>*</td>
<td>apps</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.10</td>
</tr>
<tr>
<td>console-openshift-console</td>
<td>apps</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.10</td>
</tr>
<tr>
<td>*</td>
<td>apps</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.10</td>
</tr>
<tr>
<td></td>
<td>bootstrap</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.10</td>
</tr>
<tr>
<td></td>
<td>master0</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.11</td>
</tr>
<tr>
<td></td>
<td>master1</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.12</td>
</tr>
<tr>
<td></td>
<td>master2</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.13</td>
</tr>
<tr>
<td></td>
<td>worker1</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.14</td>
</tr>
<tr>
<td></td>
<td>worker2</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.15</td>
</tr>
<tr>
<td></td>
<td>worker3</td>
<td>openshift</td>
<td>vcf.local</td>
<td>10.253.107.16</td>
</tr>
</tbody>
</table>
<figure><img src="/images/openshift/1-3.png"/><figcaption>
            <h4>DNS 구성</h4>
        </figcaption>
</figure>

<h3 id="22-dhcp-구성">2.2. DHCP 구성</h3>
<p>DHCP 구성 - NSXT로 구성을 하였다.</p>
<p><figure><img src="/images/openshift/1-4.png"/><figcaption>
            <h4>DHCP 구성#1</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/1-5.png"/><figcaption>
            <h4>DHCP 구성#2</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/1-6.png"/><figcaption>
            <h4>DHCP 구성#3</h4>
        </figcaption>
</figure>
</p>
<h2 id="3-파일-다운로드">3. 파일 다운로드</h2>
<p>OC를 다운로드 하기 위해 redhat에 가입 하고 Login 필요</p>
<p>OC 다운로드 링크  <a href="https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/auth?client_id=cloud-services&amp;redirect_uri=https%3A%2F%2Fconsole.redhat.com%2Fopenshift%2Finstall&amp;state=3c149436-35f6-4385-9739-68ad3e7cfb3e&amp;response_mode=fragment&amp;response_type=code&amp;scope=openid&amp;nonce=50b0191c-64a2-4655-81da-8ee6e7665375" target="_blank" rel="noopener noreffer"><i class="fas fa-link"></i> OC 다운로드 링크 </a></p>
<p><figure><img src="/images/openshift/1-1.png"/><figcaption>
            <h4>OC 다운로드#1</h4>
        </figcaption>
</figure>

PullSecret을 저장해 둔다. <figure><img src="/images/openshift/1-2.png"/><figcaption>
            <h4>OC 다운로드#2</h4>
        </figcaption>
</figure>
</p>
<p>압축을 해제 하고 환경변수를 별도로 구성하지 않게 /usr/local/bin 에다가 copy를 한다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">tar -xzvf openshift-client-linux.tar.gz
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">tar -xzvf openshift-install-linux.tar.gz
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mv oc kubectl openshift-install /usr/local/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">oc version
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">openshift-install version
</span></span></code></pre></td></tr></table>
</div>
</div><p>sshkeygen을 생성 한다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ssh-keygen -t ed25519 -N <span class="s1">&#39;&#39;</span> -f ~/.ssh/id_rsa
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="nb">eval</span> <span class="s2">&#34;</span><span class="k">$(</span>ssh-agent -s<span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ssh-add ~/.ssh/id_rsa
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-vcenter-ssh-thumbprint-얻기">4. vCenter SSH thumbprint 얻기</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">openssl s_client -servername vcsa01.vcf.local -connect vcsa01.vcf.local:443 <span class="p">|</span> openssl x509 <span class="p">|</span> tee ca.crt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cp ca.crt /usr/local/share/ca-certificates/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">update-ca-certificates
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-temp-image">5. Temp Image</h2>
<p><a href="https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/" target="_blank" rel="noopener noreffer"><i class="far fa-file-archive fa-fw"></i>&nbsp;RHCOS Download Link</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">wget https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/rhcos-vmware.x86_64.ova
</span></span></code></pre></td></tr></table>
</div>
</div><p>또는 아래와 같이 GUI에서 다운로드 받을 수 있다.</p>
<p><figure><img src="/images/openshift/5-1.png"/><figcaption>
            <h4>RHCOS OVA GUI 다운로드#2</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/5-2.png"/><figcaption>
            <h4>RHCOS OVA GUI 다운로드#2</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/5-3.png"/><figcaption>
            <h4>RHCOS OVA GUI 다운로드#3</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/5-4.png"/><figcaption>
            <h4>RHCOS OVA GUI 다운로드#4</h4>
        </figcaption>
</figure>
</p>
<h3 id="51-temp-구성">5.1. Temp 구성</h3>
<p><figure><img src="/images/openshift/5-5.png"/><figcaption>
            <h4>vSphere Temp Upload#1</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/5-6.png"/><figcaption>
            <h4>vSphere Temp Upload#2</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/5-7.png"/><figcaption>
            <h4>vSphere Temp Upload#3</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/5-8.png"/><figcaption>
            <h4>vSphere Temp Upload#4</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/5-9.png"/><figcaption>
            <h4>vSphere Temp Upload#5</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/5-10.png"/><figcaption>
            <h4>vSphere Temp Upload#6</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/5-11.png"/><figcaption>
            <h4>vSphere Temp Upload#7</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/5-12.png"/><figcaption>
            <h4>vSphere Temp Upload#8</h4>
        </figcaption>
</figure>
</p>
<h2 id="6-oc-install">6. OC Install</h2>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>SSL 구성<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>install-config.yaml 참조</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">baseDomain: vcf.local
</span></span><span class="line"><span class="cl">compute:
</span></span><span class="line"><span class="cl">- architecture: amd64
</span></span><span class="line"><span class="cl">  hyperthreading: Enabled
</span></span><span class="line"><span class="cl">  name: worker
</span></span><span class="line"><span class="cl">  platform: <span class="o">{}</span>
</span></span><span class="line"><span class="cl">  replicas: <span class="m">3</span>
</span></span><span class="line"><span class="cl">controlPlane:
</span></span><span class="line"><span class="cl">  architecture: amd64
</span></span><span class="line"><span class="cl">  hyperthreading: Enabled
</span></span><span class="line"><span class="cl">  name: master
</span></span><span class="line"><span class="cl">  platform: <span class="o">{}</span>
</span></span><span class="line"><span class="cl">  replicas: <span class="m">3</span>
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: null
</span></span><span class="line"><span class="cl">  name: ocp
</span></span><span class="line"><span class="cl">networking:
</span></span><span class="line"><span class="cl">  clusterNetwork:
</span></span><span class="line"><span class="cl">  - cidr: 10.128.0.0/14
</span></span><span class="line"><span class="cl">    hostPrefix: <span class="m">23</span>
</span></span><span class="line"><span class="cl">  machineNetwork:
</span></span><span class="line"><span class="cl">  - cidr: 10.0.0.0/16
</span></span><span class="line"><span class="cl">  networkType: OpenShiftSDN
</span></span><span class="line"><span class="cl">  serviceNetwork:
</span></span><span class="line"><span class="cl">  - 172.30.0.0/16
</span></span><span class="line"><span class="cl">platform:
</span></span><span class="line"><span class="cl">  vsphere:
</span></span><span class="line"><span class="cl">    apiVIP: 10.253.107.254
</span></span><span class="line"><span class="cl">    cluster: OBCLUSTER
</span></span><span class="line"><span class="cl">    datacenter: OBDC
</span></span><span class="line"><span class="cl">    defaultDatastore: vsanDatastore
</span></span><span class="line"><span class="cl">    ingressVIP: 10.253.107.253
</span></span><span class="line"><span class="cl">    network: LS-MGMT-10.253.107.x
</span></span><span class="line"><span class="cl">    password: Openbase!234
</span></span><span class="line"><span class="cl">    username: administrator@vsphere.local
</span></span><span class="line"><span class="cl">    vCenter: vcsa01.vcf.local
</span></span><span class="line"><span class="cl">  fips: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">publish: External
</span></span><span class="line"><span class="cl">pullSecret: <span class="s1">&#39;full secret 넣어줘야함&#39;</span>
</span></span><span class="line"><span class="cl">sshKey: <span class="p">|</span>
</span></span><span class="line"><span class="cl">  ssh-ed25519 AAAAC
</span></span></code></pre></td></tr></table>
</div>
</div><p>ocp 실행</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkdir ocp
</span></span><span class="line"><span class="cl">cp install-config.yaml ocp
</span></span><span class="line"><span class="cl">openshift-install create install-config --dir<span class="o">=</span>ocp
</span></span></code></pre></td></tr></table>
</div>
</div><p>Manifest 변경</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">openshift-install create manifests --dir ocp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ~/ocp/openshift
</span></span><span class="line"><span class="cl">rm -rf 99_openshift-cluster-api_master-*
</span></span><span class="line"><span class="cl">rm -rf 99_openshift-cluster-api_worker-machineset-0.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ~/ocp/manifests/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vi cluster-scheduler-02-config.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiVersion: config.openshift.io/v1
</span></span><span class="line"><span class="cl">kind: Scheduler
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: null
</span></span><span class="line"><span class="cl">  name: cluster
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  mastersSchedulable: <span class="nb">false</span>    <span class="c1">### true &gt; false change</span>
</span></span><span class="line"><span class="cl">  policy:
</span></span><span class="line"><span class="cl">    name: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">status: <span class="o">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ignition 실행</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">openshift-install create ignition-configs --dir ocp
</span></span></code></pre></td></tr></table>
</div>
</div><p>L4 VIP로 설정 필요</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | tee append-bootstrap.ign
</span></span></span><span class="line"><span class="cl"><span class="s">{
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;ignition&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;config&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;merge&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="s">        {
</span></span></span><span class="line"><span class="cl"><span class="s">          &#34;source&#34;: &#34;http://10.253.107.254:8080/bootstrap.ign&#34; ## L4 VIP로 변경
</span></span></span><span class="line"><span class="cl"><span class="s">        }
</span></span></span><span class="line"><span class="cl"><span class="s">      ] 
</span></span></span><span class="line"><span class="cl"><span class="s">    },
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;version&#34;: &#34;3.1.0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  }
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>BASE64 실행</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">base64 -w0 append-bootstrap.ign &gt; append-bootstrap.64
</span></span><span class="line"><span class="cl">base64 -w0 master.ign &gt; master.64
</span></span><span class="line"><span class="cl">base64 -w0 worker.ign &gt; worker.64
</span></span></code></pre></td></tr></table>
</div>
</div><p>웹 구성에서 파일을 다운로드 할 수 있게 file 폴더 구성 후 ign을 복사 한다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkdir -p /usr/share/nginx/html/files
</span></span><span class="line"><span class="cl">cp *.ign /usr/share/nginx/html/files/
</span></span><span class="line"><span class="cl">chmod <span class="m">644</span> /usr/share/nginx/html/files/*.ign
</span></span></code></pre></td></tr></table>
</div>
</div></div>
        </div>
    </div>
<h2 id="7-nginx">7. NGINX</h2>
<p>NGINX 설치</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">make로 설치
</span></span><span class="line"><span class="cl">apt install gcc libpcre3 libpcre3-dev libssl-dev make -y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkdir -p /var/tmp/src <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /var/tmp/src
</span></span><span class="line"><span class="cl">wget http://nginx.org/download/nginx-1.20.2.tar.gz
</span></span><span class="line"><span class="cl">tar -xzf nginx-1.20.2.tar.gz
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> nginx-1.20.2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./configure --prefix<span class="o">=</span>/var/www/html --sbin-path<span class="o">=</span>/usr/sbin/nginx --conf-path<span class="o">=</span>/etc/nginx/nginx.conf --http-log-path<span class="o">=</span>/var/log/nginx/access.log --error-log-path<span class="o">=</span>/var/log/nginx/error.log --with-pcre  --lock-path<span class="o">=</span>/var/lock/nginx.lock --pid-path<span class="o">=</span>/var/run/nginx.pid --with-http_ssl_module --with-http_image_filter_module<span class="o">=</span>dynamic --modules-path<span class="o">=</span>/etc/nginx/modules --with-http_v2_module --with-stream<span class="o">=</span>dynamic --with-http_addition_module --with-http_mp4_module --with-stream
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">make
</span></span><span class="line"><span class="cl">make install
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vi /lib/systemd/system/nginx.service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Unit<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Description</span><span class="o">=</span>The NGINX HTTP and reverse proxy server
</span></span><span class="line"><span class="cl"><span class="nv">After</span><span class="o">=</span>syslog.target network-online.target remote-fs.target nss-lookup.target
</span></span><span class="line"><span class="cl"><span class="nv">Wants</span><span class="o">=</span>network-online.target
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="o">[</span>Service<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Type</span><span class="o">=</span>forking
</span></span><span class="line"><span class="cl"><span class="nv">PIDFile</span><span class="o">=</span>/var/run/nginx.pid
</span></span><span class="line"><span class="cl"><span class="nv">ExecStartPre</span><span class="o">=</span>/usr/sbin/nginx -t
</span></span><span class="line"><span class="cl"><span class="nv">ExecStart</span><span class="o">=</span>/usr/sbin/nginx
</span></span><span class="line"><span class="cl"><span class="nv">ExecReload</span><span class="o">=</span>/usr/sbin/nginx -s reload
</span></span><span class="line"><span class="cl"><span class="nv">ExecStop</span><span class="o">=</span>/bin/kill -s QUIT <span class="nv">$MAINPID</span>
</span></span><span class="line"><span class="cl"><span class="nv">PrivateTmp</span><span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="o">[</span>Install<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></span></code></pre></td></tr></table>
</div>
</div><p>nginx.conf 설정</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">## 아래 내용 추가</span>
</span></span><span class="line"><span class="cl">vi etc/nginx/nginx.conf 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">worker_processes auto<span class="p">;</span>                    <span class="c1">## 추가  </span>
</span></span><span class="line"><span class="cl">error_log /var/log/nginx/error.log<span class="p">;</span>       <span class="c1">## 추가</span>
</span></span><span class="line"><span class="cl">pid /run/nginx.pid<span class="p">;</span>                       <span class="c1">## 추가</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">include /etc/nginx/stream.conf.d/*.conf<span class="p">;</span>  <span class="c1">## 추가</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">http <span class="o">{</span>
</span></span><span class="line"><span class="cl">    include       mime.types<span class="p">;</span>
</span></span><span class="line"><span class="cl">    default_type  application/octet-stream<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    log_format  main  <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;</span>
</span></span><span class="line"><span class="cl">                      <span class="s1">&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span>
</span></span><span class="line"><span class="cl">                      <span class="s1">&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    access_log  logs/access.log  main<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    sendfile        on<span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#tcp_nopush     on;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#keepalive_timeout  0;</span>
</span></span><span class="line"><span class="cl">    keepalive_timeout  65<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#gzip  on;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    server <span class="o">{</span>
</span></span><span class="line"><span class="cl">        listen       8081<span class="p">;</span>
</span></span><span class="line"><span class="cl">        server_name  localhost<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        location / <span class="o">{</span>
</span></span><span class="line"><span class="cl">            root   html<span class="p">;</span>
</span></span><span class="line"><span class="cl">            index  index.html index.htm<span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        error_page   <span class="m">500</span> <span class="m">502</span> <span class="m">503</span> <span class="m">504</span>  /50x.html<span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">location</span> <span class="o">=</span> /50x.html <span class="o">{</span>
</span></span><span class="line"><span class="cl">            root   html<span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    include /etc/nginx/conf.d/*.conf<span class="p">;</span>   <span class="c1">## 추가</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>웹 구성</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | tee /etc/nginx/conf.d/openshift.conf
</span></span></span><span class="line"><span class="cl"><span class="s">server {
</span></span></span><span class="line"><span class="cl"><span class="s">    listen       8080;
</span></span></span><span class="line"><span class="cl"><span class="s">    server_name  localhost;
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    location / {
</span></span></span><span class="line"><span class="cl"><span class="s">        root   /usr/share/nginx/html/files;
</span></span></span><span class="line"><span class="cl"><span class="s">        autoindex on;
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    error_page   500 502 503 504  /50x.html;
</span></span></span><span class="line"><span class="cl"><span class="s">    location = /50x.html {
</span></span></span><span class="line"><span class="cl"><span class="s">        root   /usr/share/nginx/html;
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>nginx 테스트 및 실행</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nginx -t
</span></span><span class="line"><span class="cl">systemctl restart nginx
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> nginx
</span></span></code></pre></td></tr></table>
</div>
</div><figure><img src="/images/openshift/7-1.png"/><figcaption>
            <h4>NGINX 확인</h4>
        </figcaption>
</figure>

<h2 id="8-temp-이미지로-vm-구성">8. Temp 이미지로 VM 구성</h2>
<p><code>Temp를 활용하여 bootstrap , master 3개 , worker 3개를 배포한다.</code></p>
<p><figure><img src="/images/openshift/8-1.png"/><figcaption>
            <h4>Image 구성#1</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/8-2.png"/><figcaption>
            <h4>Image 구성#2</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/8-3.png"/><figcaption>
            <h4>Image 구성#3</h4>
        </figcaption>
</figure>

base64로 변경한 값을 여기서 넣어 준다.
bootstrap : cat append-bootstrap.64 , 마스터 : cat master.64 , Worker : cat worker.64 의 값을 넣어 주면 됨
<figure><img src="/images/openshift/8-4.png"/><figcaption>
            <h4>Image 구성#4</h4>
        </figcaption>
</figure>
</p>
<h2 id="9-l4-구성">9. L4 구성</h2>
<p><code>L4장비가 없을 경우 / L4장비가 있을 경우를 생각해서 NGINX도 포함 시킴</code></p>
<h3 id="91-nsxt-l4-구성">9.1. NSXT L4 구성</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">## 설명</span>
</span></span><span class="line"><span class="cl">ocp_8080 : jumphost <span class="o">(</span>nginx에서 파일을 땡기기 위해 구성<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 배포 완료 후 bootstrap은 삭제 해도 됨</span>
</span></span><span class="line"><span class="cl">ocp-master-and-boot-machine-22623 : bootstrap 및 master
</span></span><span class="line"><span class="cl">ocp_master-and-boot-api-6443: bootstrap 및 master
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## Openshift는 Route를사용 하기 때문에 설정</span>
</span></span><span class="line"><span class="cl">ocp_443, ocp_80 : master 및 worker
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><img src="/images/openshift/9-1.png"/><figcaption>
            <h4>L4 구성#1</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/9-2.png"/><figcaption>
            <h4>L4 구성#2</h4>
        </figcaption>
</figure>
</p>
<h3 id="92-nginx-l4-구성">9.2. NGINX L4 구성</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## LB 설정</span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | tee /etc/nginx/stream.conf.d/lb.conf
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">stream{
</span></span></span><span class="line"><span class="cl"><span class="s">    upstream ocp_k8s_api {
</span></span></span><span class="line"><span class="cl"><span class="s">        #round-robin;
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.10:6443; #bootstrap
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.11:6443; #master1
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.12:6443; #master2
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.13:6443; #master3
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">    server {
</span></span></span><span class="line"><span class="cl"><span class="s">        listen 6443;
</span></span></span><span class="line"><span class="cl"><span class="s">        proxy_pass ocp_k8s_api;
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    upstream ocp_m_config {
</span></span></span><span class="line"><span class="cl"><span class="s">        #round-robin;
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.10:22623; #bootstrap
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.11:22623; #master1
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.12:22623; #master2
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.13:22623; #master3
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">    server {
</span></span></span><span class="line"><span class="cl"><span class="s">        listen 22623;
</span></span></span><span class="line"><span class="cl"><span class="s">        proxy_pass ocp_m_config;
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    upstream ocp_http {
</span></span></span><span class="line"><span class="cl"><span class="s">        #round-robin;
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.11:80; #master1
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.12:80; #master2
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.13:80; #master3
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.14:80; #worker1
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.15:80; #worker2
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.16:80; #worker3
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">    server{
</span></span></span><span class="line"><span class="cl"><span class="s">        listen 80;
</span></span></span><span class="line"><span class="cl"><span class="s">        proxy_pass ocp_http;
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    upstream ocp_https {
</span></span></span><span class="line"><span class="cl"><span class="s">        #round-robin;
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.11:443; #master1
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.12:443; #master2
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.13:443; #master3
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.14:443; #worker1
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.15:443; #worker2
</span></span></span><span class="line"><span class="cl"><span class="s">        server 10.253.107.16:443; #worker3   
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">    server{
</span></span></span><span class="line"><span class="cl"><span class="s">        listen 443;
</span></span></span><span class="line"><span class="cl"><span class="s">        proxy_pass ocp_https;
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## nginx restart</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">nginx -t
</span></span><span class="line"><span class="cl">systemctl restart nginx
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="10-완료-후-확인">10. 완료 후 확인</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>&lt;installation_directory&gt;/auth/kubeconfig
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">예시
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>~/ocp/auth/kubeconfig
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">oc whoami
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">oc get clusterversion
</span></span></code></pre></td></tr></table>
</div>
</div><figure><img src="/images/openshift/10-1.png"/><figcaption>
            <h4>완료#1</h4>
        </figcaption>
</figure>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">oc get clusteroperators
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">oc describe clusterversion
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">oc get clusterversion -o jsonpath=&#39;{.items[0].spec}{&#34;\n&#34;}&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><img src="/images/openshift/10-2.png"/><figcaption>
            <h4>완료#2</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/10-3.png"/><figcaption>
            <h4>완료#3</h4>
        </figcaption>
</figure>
</p>
<h2 id="11-new-worker-node-add">11. New Worker Node Add</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">## PENDING 확인</span>
</span></span><span class="line"><span class="cl">kubectl get csr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## PENDING 확인 후 적용</span>
</span></span><span class="line"><span class="cl">oc adm certificate approve csr-bghmp csr-hd9x8 csr-hlngb
</span></span><span class="line"><span class="cl">oc adm certificate approve csr-gpgv9 csr-n6lqm csr-zfws6 
</span></span></code></pre></td></tr></table>
</div>
</div><figure><img src="/images/openshift/11-1.png"/><figcaption>
            <h4>worker Node 추가</h4>
        </figcaption>
</figure>

<h2 id="12-계정">12. 계정</h2>
<p>Local 또는 AD을 통해 계정을 관리 할 수 있다.</p>
<h3 id="121-local-계정-생성">12.1. Local 계정 생성</h3>
<p>아래는 htpasswd를 사용 하는 방법의 대해서 구성 한다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">## 우분투</span>
</span></span><span class="line"><span class="cl">apt install apache2-utils -y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 유저 정보</span>
</span></span><span class="line"><span class="cl"><span class="c1"># htpasswd -Bbc htpasswd {username} &#39;{password}&#39;</span>
</span></span><span class="line"><span class="cl">$ htpasswd -Bbc htpasswd my1208 <span class="s1">&#39;Passw0rd&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat htpasswd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">oc --user<span class="o">=</span>admin create secret generic htpasswd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --from-file<span class="o">=</span>htpasswd -n openshift-config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">oc get secret -n openshift-config
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><img src="/images/openshift/11-2.png"/><figcaption>
            <h4>유저 추가</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/11-3.png"/><figcaption>
            <h4>secret 확인</h4>
        </figcaption>
</figure>
</p>
<p>secret 추가</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | tee oauth-config.yaml
</span></span></span><span class="line"><span class="cl"><span class="s"># oauth-config.yaml
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: config.openshift.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: OAuth
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: cluster
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  identityProviders:
</span></span></span><span class="line"><span class="cl"><span class="s">  - name: Local Password
</span></span></span><span class="line"><span class="cl"><span class="s">    mappingMethod: claim
</span></span></span><span class="line"><span class="cl"><span class="s">    type: HTPasswd
</span></span></span><span class="line"><span class="cl"><span class="s">    htpasswd:
</span></span></span><span class="line"><span class="cl"><span class="s">      fileData:
</span></span></span><span class="line"><span class="cl"><span class="s">        name: htpasswd
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">oc replace -f oauth-config.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## shows current user</span>
</span></span><span class="line"><span class="cl">oc whoami
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## shows cluster web console URL</span>
</span></span><span class="line"><span class="cl">oc whoami --show-console
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## shows cluster API URL</span>
</span></span><span class="line"><span class="cl">oc whoami --show-server
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## shows current OAuth token</span>
</span></span><span class="line"><span class="cl">oc whoami --show-token
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><img src="/images/openshift/11-4.png"/><figcaption>
            <h4>GUI 접속#1</h4>
        </figcaption>
</figure>

<figure><img src="/images/openshift/11-5.png"/><figcaption>
            <h4>GUI 접속#2</h4>
        </figcaption>
</figure>
</p>
<h3 id="122-ad-연동">12.2. AD 연동</h3>
<p>LDPAS를 구성하기 위한 configmap 생성</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">oc create configmap ca-config-map --from-file=ca.crt=/path/to/ca -n openshift-config
</span></span></code></pre></td></tr></table>
</div>
</div><p>만약 LDAPS로 구성을 하지 않았으면 insecure: true, ca 항목을 삭제, url을 ldap으로 변경을 해주면 된다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">oc apply -n openshift-config -f - <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: config.openshift.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: OAuth
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: cluster
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  identityProviders:
</span></span></span><span class="line"><span class="cl"><span class="s">  - name: ldapidp
</span></span></span><span class="line"><span class="cl"><span class="s">    mappingMethod: claim
</span></span></span><span class="line"><span class="cl"><span class="s">    type: LDAP
</span></span></span><span class="line"><span class="cl"><span class="s">    ldap:
</span></span></span><span class="line"><span class="cl"><span class="s">      attributes:
</span></span></span><span class="line"><span class="cl"><span class="s">        id:
</span></span></span><span class="line"><span class="cl"><span class="s">        - dn
</span></span></span><span class="line"><span class="cl"><span class="s">        email:
</span></span></span><span class="line"><span class="cl"><span class="s">        - mail
</span></span></span><span class="line"><span class="cl"><span class="s">        name:
</span></span></span><span class="line"><span class="cl"><span class="s">        - sAMAccountName
</span></span></span><span class="line"><span class="cl"><span class="s">        preferredUsername:
</span></span></span><span class="line"><span class="cl"><span class="s">        - sAMAccountName
</span></span></span><span class="line"><span class="cl"><span class="s">      bindDN: cn=administrator,cn=users,dc=tkg,dc=io
</span></span></span><span class="line"><span class="cl"><span class="s">      bindPassword:
</span></span></span><span class="line"><span class="cl"><span class="s">        name: ldap-secret
</span></span></span><span class="line"><span class="cl"><span class="s">      ca:
</span></span></span><span class="line"><span class="cl"><span class="s">        name: ca-config-map
</span></span></span><span class="line"><span class="cl"><span class="s">      insecure: false
</span></span></span><span class="line"><span class="cl"><span class="s">      url: &#34;ldaps://tanzu-dns.tkg.io/ou=tanzu,dc=tkg,dc=io?sAMAccountName&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><img src="/images/openshift/12-1.png"/><figcaption>
            <h4>GUI 접속</h4>
        </figcaption>
</figure>

<h3 id="123-수동-group-sync">12.3. 수동 GROUP-SYNC</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">vi ldapsync.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># LDAP is case insensitive, but OpenShift is not, so all LDAP parameters have been converted to lower case as per https://access.redhat.com/solutions/3232051 (under &#34;Case Sensitivity&#34;)</span>
</span></span><span class="line"><span class="cl">kind: LDAPSyncConfig
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">url: ldaps://tanzu-dns.tkg.io:636
</span></span><span class="line"><span class="cl">insecure: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">ca: <span class="s2">&#34;/data/cert/ldapserver.pem&#34;</span>                       <span class="c1">### ldaps 인증서의 실제 위치 / 파일</span>
</span></span><span class="line"><span class="cl">bindDN: <span class="nv">cn</span><span class="o">=</span>administrator,cn<span class="o">=</span>users,dc<span class="o">=</span>tkg,dc<span class="o">=</span>io
</span></span><span class="line"><span class="cl">bindPassword: <span class="s2">&#34;Password&#34;</span>
</span></span><span class="line"><span class="cl">rfc2307:
</span></span><span class="line"><span class="cl">   groupsQuery:
</span></span><span class="line"><span class="cl">       baseDN: <span class="s2">&#34;ou=tanzu,dc=tkg,dc=io&#34;</span>
</span></span><span class="line"><span class="cl">       scope: sub
</span></span><span class="line"><span class="cl">       filter: <span class="o">(</span><span class="nv">objectClass</span><span class="o">=</span>group<span class="o">)</span>
</span></span><span class="line"><span class="cl">       derefAliases: never
</span></span><span class="line"><span class="cl">       timeout: <span class="m">0</span>
</span></span><span class="line"><span class="cl">       pageSize: <span class="m">0</span>
</span></span><span class="line"><span class="cl">   groupUIDAttribute: dn
</span></span><span class="line"><span class="cl">   groupNameAttributes: <span class="o">[</span> cn <span class="o">]</span>
</span></span><span class="line"><span class="cl">   groupMembershipAttributes: <span class="o">[</span> member <span class="o">]</span>
</span></span><span class="line"><span class="cl">   usersQuery:
</span></span><span class="line"><span class="cl">       basedn: <span class="s2">&#34;ou=tanzu,dc=tkg,dc=io&#34;</span>
</span></span><span class="line"><span class="cl">       scope: sub
</span></span><span class="line"><span class="cl">       derefAliases: never
</span></span><span class="line"><span class="cl">       pageSize: <span class="m">0</span>
</span></span><span class="line"><span class="cl">   userUIDAttribute: dn
</span></span><span class="line"><span class="cl">   userNameAttributes: <span class="o">[</span> cn <span class="o">]</span>
</span></span><span class="line"><span class="cl">   tolerateMemberNotFoundErrors: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">   tolerateMemberOutOfScopeErrors: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="c1">## 적용전 제대로 받아오는지 확인을 한다.</span>
</span></span><span class="line"><span class="cl">oc adm groups sync --sync-config<span class="o">=</span>ldapsync.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 확인이 끝나면 적용한다.</span>
</span></span><span class="line"><span class="cl">oc adm groups sync --sync-config<span class="o">=</span>ldapsync.yaml --confirm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 권한 설정</span>
</span></span><span class="line"><span class="cl">oc adm policy add-cluster-role-to-group cluster-admin tkg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 권한 삭제</span>
</span></span><span class="line"><span class="cl">oc adm policy remove-cluster-role-from-group cluster-admin tkg
</span></span></code></pre></td></tr></table>
</div>
</div><figure><img src="/images/openshift/12-2.png"/><figcaption>
            <h4>GROUP 확인 및 적용</h4>
        </figcaption>
</figure>

<h3 id="124-cronjob-group-sync">12.4 CronJob Group-Sync</h3>
<p>위에서 LDAP을 연동 하였다면 cm , secret 이 생성 된 것을 확인 할 수 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">## password 이름 확인</span>
</span></span><span class="line"><span class="cl"><span class="nv">password</span><span class="o">=</span><span class="sb">`</span>oc get secret -n openshift-authentication <span class="p">|</span> grep v4-0-config-user-idp-0 <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">oc get secret -n openshift-authentication <span class="nv">$password</span>  -o <span class="nv">jsonpath</span><span class="o">={</span>.data<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 인증서 이름 확인</span>
</span></span><span class="line"><span class="cl"><span class="nv">ca</span><span class="o">=</span><span class="sb">`</span>oc get cm -n openshift-authentication <span class="p">|</span> grep v4-0-config-user <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">oc get cm -n openshift-authentication <span class="nv">$ca</span> -o <span class="nv">jsonpath</span><span class="o">={</span>.items<span class="o">[</span>0<span class="o">]</span>.data<span class="o">}</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>그리고 계정 및 권한 설정을 해준다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | tee ldap-sync-sa-clusterrole.yaml
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ServiceAccount
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ldap-group-syncer
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: openshift-authentication
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: cronjob-ldap-group-sync
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ServiceAccount
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ldap-group-syncer
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: openshift-authentication
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: cronjob-ldap-group-sync
</span></span></span><span class="line"><span class="cl"><span class="s">root@ubuntu:/var/tmp/oc/ldaps#
</span></span></span><span class="line"><span class="cl"><span class="s">root@ubuntu:/var/tmp/oc/ldaps# cat clusterrole.yaml
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ClusterRole
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ldap-group-syncer
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: cronjob-ldap-group-sync
</span></span></span><span class="line"><span class="cl"><span class="s">rules:
</span></span></span><span class="line"><span class="cl"><span class="s">  - apiGroups:
</span></span></span><span class="line"><span class="cl"><span class="s">      - &#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">      - user.openshift.io
</span></span></span><span class="line"><span class="cl"><span class="s">    resources:
</span></span></span><span class="line"><span class="cl"><span class="s">      - groups
</span></span></span><span class="line"><span class="cl"><span class="s">    verbs:
</span></span></span><span class="line"><span class="cl"><span class="s">      - get
</span></span></span><span class="line"><span class="cl"><span class="s">      - list
</span></span></span><span class="line"><span class="cl"><span class="s">      - create
</span></span></span><span class="line"><span class="cl"><span class="s">      - update
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ClusterRoleBinding
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ldap-group-syncer
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: cronjob-ldap-group-sync
</span></span></span><span class="line"><span class="cl"><span class="s">subjects:
</span></span></span><span class="line"><span class="cl"><span class="s">  - kind: ServiceAccount
</span></span></span><span class="line"><span class="cl"><span class="s">    name: ldap-group-syncer
</span></span></span><span class="line"><span class="cl"><span class="s">    namespace: openshift-authentication
</span></span></span><span class="line"><span class="cl"><span class="s">roleRef:
</span></span></span><span class="line"><span class="cl"><span class="s">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span class="line"><span class="cl"><span class="s">  kind: ClusterRole
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ldap-group-syncer
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>LDAP의 자동 Sync를 구성하기 위해 config-map 및 job 설정
witelist / balcklist의 경우 ldapsearch에서 distinguishedName: CN=test test,OU=tanzu,DC=tkg,DC=io 이부분의 이름으로 넣어야함. , 만약 별도로 witelist / blacklist가 필요 없으면 제거 해도 된다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | tee ldap-sync-cm-cron.yaml
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ConfigMap
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ldap-group-syncer
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: openshift-authentication
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: cronjob-ldap-group-sync
</span></span></span><span class="line"><span class="cl"><span class="s">data:
</span></span></span><span class="line"><span class="cl"><span class="s">  ldap-group-sync.yaml: |
</span></span></span><span class="line"><span class="cl"><span class="s">    kind: LDAPSyncConfig
</span></span></span><span class="line"><span class="cl"><span class="s">    apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">    url: ldaps://tanzu-dns.tkg.io
</span></span></span><span class="line"><span class="cl"><span class="s">    bindDN: cn=administrator,cn=users,dc=tkg,dc=io
</span></span></span><span class="line"><span class="cl"><span class="s">    bindPassword:
</span></span></span><span class="line"><span class="cl"><span class="s">      file: &#34;/etc/secrets/bindPassword&#34;                   ## 위에서 설명한 secret, cronjob에서 voluemount 후 적용
</span></span></span><span class="line"><span class="cl"><span class="s">    insecure: false
</span></span></span><span class="line"><span class="cl"><span class="s">    ca: &#34;/ldap-sync/ca/ca.crt&#34;                            ## 위에서 설명한 configmap, cronjob에서 voluemount 후 적용
</span></span></span><span class="line"><span class="cl"><span class="s">    rfc2307:
</span></span></span><span class="line"><span class="cl"><span class="s">        groupsQuery:
</span></span></span><span class="line"><span class="cl"><span class="s">            baseDN: &#34;ou=tanzu,dc=tkg,dc=io&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">            scope: sub
</span></span></span><span class="line"><span class="cl"><span class="s">            derefAliases: never
</span></span></span><span class="line"><span class="cl"><span class="s">            filter: (objectclass=group)
</span></span></span><span class="line"><span class="cl"><span class="s">        groupUIDAttribute: dn
</span></span></span><span class="line"><span class="cl"><span class="s">        groupNameAttributes: [ cn ]
</span></span></span><span class="line"><span class="cl"><span class="s">        groupMembershipAttributes: [ member ]
</span></span></span><span class="line"><span class="cl"><span class="s">        usersQuery:
</span></span></span><span class="line"><span class="cl"><span class="s">            baseDN: &#34;ou=tanzu,dc=tkg,dc=io&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">            scope: sub
</span></span></span><span class="line"><span class="cl"><span class="s">            derefAliases: never
</span></span></span><span class="line"><span class="cl"><span class="s">            pageSize: 0
</span></span></span><span class="line"><span class="cl"><span class="s">        userUIDAttribute: dn
</span></span></span><span class="line"><span class="cl"><span class="s">        userNameAttributes: [ sAMAccountName ]
</span></span></span><span class="line"><span class="cl"><span class="s">        tolerateMemberNotFoundErrors: true
</span></span></span><span class="line"><span class="cl"><span class="s">        tolerateMemberOutOfScopeErrors: true
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ConfigMap
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ldap-group-syncer-whitelist
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: openshift-authentication
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: cronjob-ldap-group-sync
</span></span></span><span class="line"><span class="cl"><span class="s">data:
</span></span></span><span class="line"><span class="cl"><span class="s">  whitelist.txt: |
</span></span></span><span class="line"><span class="cl"><span class="s">    CN=kim dokyung,OU=tanzu,DC=tkg,DC=io
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ConfigMap
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ldap-group-syncer-blacklist
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: openshift-authentication
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: cronjob-ldap-group-sync
</span></span></span><span class="line"><span class="cl"><span class="s">data:
</span></span></span><span class="line"><span class="cl"><span class="s">  blacklist.txt: |
</span></span></span><span class="line"><span class="cl"><span class="s">    CN=tkg,OU=tanzu,DC=tkg,DC=io
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">kind: CronJob
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: batch/v1beta1
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ldap-group-syncer
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: openshift-authentication
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: cronjob-ldap-group-sync
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  schedule: &#34;*/1 * * * *&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  concurrencyPolicy: Forbid
</span></span></span><span class="line"><span class="cl"><span class="s">  successfulJobsHistoryLimit: 5
</span></span></span><span class="line"><span class="cl"><span class="s">  failedJobsHistoryLimit: 5
</span></span></span><span class="line"><span class="cl"><span class="s">  jobTemplate:
</span></span></span><span class="line"><span class="cl"><span class="s">    metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">      labels:
</span></span></span><span class="line"><span class="cl"><span class="s">        app: cronjob-ldap-group-sync
</span></span></span><span class="line"><span class="cl"><span class="s">    spec:
</span></span></span><span class="line"><span class="cl"><span class="s">      backoffLimit: 0
</span></span></span><span class="line"><span class="cl"><span class="s">      template:
</span></span></span><span class="line"><span class="cl"><span class="s">        metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">          labels:
</span></span></span><span class="line"><span class="cl"><span class="s">            app: cronjob-ldap-group-sync
</span></span></span><span class="line"><span class="cl"><span class="s">        spec:
</span></span></span><span class="line"><span class="cl"><span class="s">          containers:
</span></span></span><span class="line"><span class="cl"><span class="s">            - name: ldap-group-sync
</span></span></span><span class="line"><span class="cl"><span class="s">              image: &#34;registry.redhat.io/openshift4/ose-cli:v4.7&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">              command:
</span></span></span><span class="line"><span class="cl"><span class="s">                - &#34;/bin/bash&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                - &#34;-c&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                - oc adm groups sync --whitelist=/etc/whitelist/whitelist.txt --blacklist=/etc/blacklist/blacklist.txt --sync-config=/etc/config/ldap-group-sync.yaml --confirm
</span></span></span><span class="line"><span class="cl"><span class="s">              volumeMounts:
</span></span></span><span class="line"><span class="cl"><span class="s">                - mountPath: &#34;/etc/blacklist&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                  name: &#34;ldap-sync-volume-blacklist&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                - mountPath: &#34;/etc/whitelist&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                  name: &#34;ldap-sync-volume-whitelist&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                - mountPath: &#34;/etc/config&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                  name: &#34;ldap-sync-volume&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                - mountPath: &#34;/etc/secrets&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                  name: &#34;ldap-bind-password&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                - mountPath: &#34;/ldap-sync/ca&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                  name: &#34;ldap-sync-ca&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">          volumes:
</span></span></span><span class="line"><span class="cl"><span class="s">            - name: &#34;ldap-sync-volume-blacklist&#34;                  ## volumes을 모두 연결하여 assign
</span></span></span><span class="line"><span class="cl"><span class="s">              configMap:
</span></span></span><span class="line"><span class="cl"><span class="s">                name: &#34;ldap-group-syncer-blacklist&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">            - name: &#34;ldap-sync-volume-whitelist&#34;                  ## volumes을 모두 연결하여 assign
</span></span></span><span class="line"><span class="cl"><span class="s">              configMap:
</span></span></span><span class="line"><span class="cl"><span class="s">                name: &#34;ldap-group-syncer-whitelist&#34;           
</span></span></span><span class="line"><span class="cl"><span class="s">            - name: &#34;ldap-sync-volume&#34;                            ## volumes을 모두 연결하여 assign
</span></span></span><span class="line"><span class="cl"><span class="s">              configMap:
</span></span></span><span class="line"><span class="cl"><span class="s">                name: &#34;ldap-group-syncer&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">            - name: &#34;ldap-sync-ca&#34;                                ## volumes을 모두 연결하여 assign
</span></span></span><span class="line"><span class="cl"><span class="s">              configMap:
</span></span></span><span class="line"><span class="cl"><span class="s">                name: &#34;v4-0-config-user-idp-0-ca&#34; 
</span></span></span><span class="line"><span class="cl"><span class="s">            - name: &#34;ldap-bind-password&#34;                          ## volumes을 모두 연결하여 assign
</span></span></span><span class="line"><span class="cl"><span class="s">              secret:
</span></span></span><span class="line"><span class="cl"><span class="s">                secretName: &#34;v4-0-config-user-idp-0-bind-password&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">          restartPolicy: &#34;Never&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">          terminationGracePeriodSeconds: 30
</span></span></span><span class="line"><span class="cl"><span class="s">          activeDeadlineSeconds: 500
</span></span></span><span class="line"><span class="cl"><span class="s">          dnsPolicy: &#34;ClusterFirst&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">          serviceAccountName: &#34;ldap-group-syncer&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">          serviceAccount: &#34;ldap-group-syncer&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>이후에 자동으로 싱크가 되는 것을 알수 있다. 만약에 그룹을 추가 했는대 그 그룹만 막고 싶으면 blacklist, 또는 기존에 있는 것만 하고 자동 싱크 하고 싶으면 witelist를 적용 하면된다. 
흠 생각에는 그냥 witelist 방식으로만 적용하면 될 것으로 보인다. 만약에 필요 하다면 필요 없이 모든 그룹을 자동 싱크 하겠따면 witelist / blaklist는 필요 없다.</p>
<p>자동 싱크가 되었으면 해당하는 그룹에 권한을 준다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">## 권한 설정</span>
</span></span><span class="line"><span class="cl">oc adm policy add-cluster-role-to-group cluster-admin tkg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 권한 삭제</span>
</span></span><span class="line"><span class="cl">oc adm policy remove-cluster-role-from-group cluster-admin tkg
</span></span></code></pre></td></tr></table>
</div>
</div><figure><img src="/images/openshift/12-3.png"/><figcaption>
            <h4>자동 sync 구성 완료</h4>
        </figcaption>
</figure>

</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-03-09&nbsp;<a class="git-hash" href="https://github.com/huntedhappy/huntedhappy.github.io/commit/1ac1f175530ee369dee9a15c432cff7a943950fe" target="_blank" title="commit by huntedhappy(huntedhappy.gmail.com) 1ac1f175530ee369dee9a15c432cff7a943950fe: first">
                                    <i class="fas fa-hashtag fa-fw"></i>1ac1f17</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/ko/openshift/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://huntedhappy.github.io/ko/openshift/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Share on Blogger" data-sharer="blogger" data-url="https://huntedhappy.github.io/ko/openshift/" data-title="The Documentation Openshift" data-description="Opshift Install Guide"><i class="fab fa-blogger fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/ko/tags/openshift/">openshift</a>,&nbsp;<a href="/ko/tags/k8s/">k8s</a>,&nbsp;<a href="/ko/tags/devops/">devops</a>,&nbsp;<a href="/ko/tags/dk/">dk</a>,&nbsp;<a href="/ko/tags/dokyung/">dokyung</a>,&nbsp;<a href="/ko/tags/ldap%EC%97%B0%EB%8F%99/">ldap연동</a>,&nbsp;<a href="/ko/tags/openshift-ldap/">openshift ldap</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/ko/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/ko/eks/" class="prev" rel="prev" title="The Documentation EKS"><i class="fas fa-angle-left fa-fw"></i>The Documentation EKS</a>
            <a href="/ko/nap/" class="next" rel="next" title="The Documentation NAP">The Documentation NAP<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="utterances"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">Utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021-12-29 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://huntedhappy.tistory.com" target="_blank">Dokyung</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/twemoji/twemoji.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"comments","lightTheme":"github-light","repo":"huntedhappy/comments"}},"data":{"id-1":"Dokyung's DevOoOps","id-2":"Dokyung's DevOoOps"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.ko","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"algolia"},"twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', '216068312', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=216068312" async></script></body>
</html>
