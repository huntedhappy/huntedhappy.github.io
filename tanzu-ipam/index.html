<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>The Documentation IPAM on TANZU - Dokyung&#39;s DevOoOps</title><meta name="Description" content="IPAM on TANZU"><meta property="og:title" content="The Documentation IPAM on TANZU" />
<meta property="og:description" content="IPAM on TANZU" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://huntedhappy.github.io/tanzu-ipam/" /><meta property="og:image" content="https://huntedhappy.github.io/tanzu-ipam/ipam.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-24T01:42:56+09:00" />
<meta property="article:modified_time" content="2023-05-24T02:19:39+09:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://huntedhappy.github.io/tanzu-ipam/ipam.png"/>
<meta name="twitter:title" content="The Documentation IPAM on TANZU"/>
<meta name="twitter:description" content="IPAM on TANZU"/>
<meta name="application-name" content="Dokyung&#39;s DevOoOps">
<meta name="apple-mobile-web-app-title" content="Dokyung&#39;s DevOoOps"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://huntedhappy.github.io/tanzu-ipam/" /><link rel="prev" href="https://huntedhappy.github.io/tmc/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "The Documentation IPAM on TANZU",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/huntedhappy.github.io\/tanzu-ipam\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/huntedhappy.github.io\/tanzu-ipam\/ipam.png",
                            "width":  1200 ,
                            "height":  345 
                        }],"genre": "posts","keywords": "tanzu, k8s, ipam, devops, dk, dokyung","wordcount":  756 ,
        "url": "https:\/\/huntedhappy.github.io\/tanzu-ipam\/","datePublished": "2023-05-24T01:42:56+09:00","dateModified": "2023-05-24T02:19:39+09:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Dokyung"},"author": {
                "@type": "Person",
                "name": "Dokyung"
            },"description": "IPAM on TANZU"
    }
    </script></head>
    <body header-desktop="auto" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Dokyung&#39;s DevOoOps"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/categories/documentation/"> Docs </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/huntedhappy" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Select Language">한국어<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/ko/tanzu-ipam/">Korean</option><option value="/tanzu-ipam/" selected>한국어</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Dokyung&#39;s DevOoOps"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/categories/documentation/" title="">Docs</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/huntedhappy" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language">한국어<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/ko/tanzu-ipam/">Korean</option><option value="/tanzu-ipam/" selected>한국어</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">The Documentation IPAM on TANZU</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://huntedhappy.tistory.com" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Dokyung</a></span>&nbsp;<span class="post-category">included in <a href="/categories/documentation/"><i class="far fa-folder fa-fw"></i>Documentation</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-05-24">2023-05-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;756 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/tanzu-ipam/ipam.png"
        data-srcset="/tanzu-ipam/ipam.png, /tanzu-ipam/ipam.png 1.5x, /tanzu-ipam/ipam.png 2x"
        data-sizes="auto"
        alt="/tanzu-ipam/ipam.png"
        title="IPAM on TANZU" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents"></nav></div>
            </div><div class="content" id="content"><h1 id="1--ipam-on-tanzu">1.  IPAM ON TANZU</h1>
<p>탄주는 기본적으로 DHCP 서버가 필요 하다. K8S 환경을 유지 하기 위해 VM의 라이프 사이클을 제공 하고 있기 때문이다. 그렇기 때문에 VM에 HANG이 걸리거나, 삭제가 되면 자동적으로 복구를 하게 된다. K8S에서 POD를 관리 하는 것처럼 탄주는 Master, Worker Node를 하나의 POD로 인식을 하게 설계를 한게 아닌가 싶다. 하지만 이런 자동화 시스템으로 인하여 STATIC하게 IP를 넣을 수도 없으며(DHCP서버를 통해 배포 후 IP를 변경 할 수 있겠지만 권장 하지 않는다.) 무조건적으로 DHCP 서버가 필요 하기 때문에 설치시 많은 어려움이 있을 수 있다. 또한 DHCP 서버를 운영 함으로 인해서 불필요한 자원을 사용하게 될 수도 있다.</p>
<p>지금 작성 하는 부분은 DHCP서버를 완전히 배제 할 수는 없다. 다만 메니저 클러스터를 배포 한 후 CLUSTER의 IP는 관리 클러스터에서 관리를 할 수 있게 설정을 할 수 있다. 두가지 방법이 있을 수 있는대 처음은 YTT를 구성함으로 인해서 처음부터 클러스터가 배포 될 경우 IP를 할당 받을 수 있게 할 수 도 있으며, 두번째로는 클러스터를 DHCP서버를 배포 후 IPAM을 사용하게 구성 할 수 있다.</p>
<p>당연히 YTT로 구성을 하여서 처음부터 배포를 하는 것이 권장을 할 것이다. 하지만 한편으로는 걱정도 된다. 이렇게 구성 함으로 인해서 업그레이드가 잘 될지.. (추후에 업그레이드도 진행을 해봐야 할 것이다&hellip;)</p>
<p>현재 작성하는 방법은 2번째 방법으로 진행 할 예정이다. 
방법은 간단하다. 우선 metal3-io가 무엇을 하는지는 알지 못하지만 해당 github에서 제공을 받아 설치를 해볼 수 있을 것이다.</p>
<p>아래와 같이 GIT을 다운로드 받은 후 간단하게 실행을 해준다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone https://github.com/arbhoj/vsphere-ipam.git
</span></span><span class="line"><span class="cl">kubectl apply -f vsphere-ipam/metal3ipam/provider-components/infrastructure-components.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f vsphere-ipam/spectro-ipam-adapter/install.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>그리고 아래와 같이 환경 변수를 적용해도 되고, 그냥 입력을 해도 된다. 편한대로 설정을 해보자</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CLUSTER_NAME</span><span class="o">=</span>run2
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NETWORK_NAME</span><span class="o">=</span>LS-TKGM01-WORKLOAD-10.253.127.x <span class="c1">#This is the name of the network to be used in vSphere</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">START_IP</span><span class="o">=</span>10.253.127.120
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">END_IP</span><span class="o">=</span>10.253.127.130
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CIDR</span><span class="o">=</span><span class="m">24</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">GATEWAY</span><span class="o">=</span>10.253.127.1
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DNS_SERVER</span><span class="o">=</span>10.253.107.2
</span></span></code></pre></td></tr></table>
</div>
</div><p>위와 같이 환경변수를 적용 후 ippol을 실행 해주자.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: ipam.metal3.io/v1alpha1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: IPPool
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ${CLUSTER_NAME}-pool
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    cluster.x-k8s.io/network-name: ${NETWORK_NAME}
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  clusterName: ${CLUSTER_NAME}
</span></span></span><span class="line"><span class="cl"><span class="s">  namePrefix: ${CLUSTER_NAME}-prov
</span></span></span><span class="line"><span class="cl"><span class="s">  pools:
</span></span></span><span class="line"><span class="cl"><span class="s">    - start: ${START_IP}
</span></span></span><span class="line"><span class="cl"><span class="s">      end: ${END_IP}
</span></span></span><span class="line"><span class="cl"><span class="s">      prefix: ${CIDR}
</span></span></span><span class="line"><span class="cl"><span class="s">      gateway: ${GATEWAY}
</span></span></span><span class="line"><span class="cl"><span class="s">  prefix: 24
</span></span></span><span class="line"><span class="cl"><span class="s">  gateway: ${GATEWAY}
</span></span></span><span class="line"><span class="cl"><span class="s">  dnsServers: [${DNS_SERVER}]
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>그리고 machine에다가 lables을 붙여주어야 한다. 지금 해도 되고 새로 생성 할 때 해도 된다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl label vspheremachinetemplates run2-control-plane cluster.x-k8s.io/ip-pool-name<span class="o">=</span>run2-pool
</span></span><span class="line"><span class="cl">kubectl label vspheremachinetemplates run2-worker cluster.x-k8s.io/ip-pool-name<span class="o">=</span>run2-pool
</span></span></code></pre></td></tr></table>
</div>
</div><p>이렇게 구성을 하였다고 하더라도 실제적으로 vspheremachinetemplates 여기에 수정을 할 수가 없기 때문에 별도로 새로 생성을 해야 한다. 아마 이 부분은 vmsizing을 변경 할 때 많이 봤을 수도 있다. vmsizing은 이렇게 변경도 가능하지만 왠만하면 nodepool을 사용하여서 변경하는게 좋지 않을가 하는 생각을 잠시 한다.</p>
<p>아래와 같이 주석 처리 한부분을 추가 및 변경을 해준다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl get VSphereMachineTemplate run2-control-plane -o yaml <span class="p">|</span> kubectl neat &gt; run2-control-plane.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vi run2-control-plan.yaml
</span></span><span class="line"><span class="cl">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
</span></span><span class="line"><span class="cl">kind: VSphereMachineTemplate
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    vmTemplateMoid: vm-134165
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    cluster.x-k8s.io/ip-pool-name: run2-pool   <span class="c1">## ippool이랑 name 일치 하는지 확인</span>
</span></span><span class="line"><span class="cl">  name: run2-control-plane01
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      cloneMode: fullClone
</span></span><span class="line"><span class="cl">      datacenter: /OBDC
</span></span><span class="line"><span class="cl">      datastore: /OBDC/datastore/vsanDatastore
</span></span><span class="line"><span class="cl">      diskGiB: <span class="m">300</span>
</span></span><span class="line"><span class="cl">      folder: /OBDC/vm/tanzu
</span></span><span class="line"><span class="cl">      memoryMiB: <span class="m">8192</span>
</span></span><span class="line"><span class="cl">      network:
</span></span><span class="line"><span class="cl">        devices:
</span></span><span class="line"><span class="cl">        - dhcp4: <span class="nb">false</span>   <span class="c1">#### 변경</span>
</span></span><span class="line"><span class="cl">          networkName: /OBDC/network/LS-TKGM01-WORKLOAD-10.253.127.x
</span></span><span class="line"><span class="cl">      numCPUs: <span class="m">4</span>
</span></span><span class="line"><span class="cl">      resourcePool: /OBDC/host/OBCLUSTER/Resources/dk-tanzu
</span></span><span class="line"><span class="cl">      server: vcsa01.vcf.local
</span></span><span class="line"><span class="cl">      storagePolicyName: k8s
</span></span><span class="line"><span class="cl">      template: /OBDC/vm/temp/photon-3-kube-v1.24.10+vmware.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl apply -f run2-control-plan.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>마찬가지로 worker노드도 템플릿을 생성 해준다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get VSphereMachineTemplate run2-worker -o yaml <span class="p">|</span> kubectl neat &gt; run2-worker.yaml
</span></span><span class="line"><span class="cl">vi run2-worker.yaml
</span></span><span class="line"><span class="cl">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
</span></span><span class="line"><span class="cl">kind: VSphereMachineTemplate
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    vmTemplateMoid: vm-134165
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    cluster.x-k8s.io/ip-pool-name: run2-pool    <span class="c1">## ippool이랑 name 일치 하는지 확인</span>
</span></span><span class="line"><span class="cl">  name: run2-worker01
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      cloneMode: fullClone
</span></span><span class="line"><span class="cl">      datacenter: /OBDC
</span></span><span class="line"><span class="cl">      datastore: /OBDC/datastore/vsanDatastore
</span></span><span class="line"><span class="cl">      diskGiB: <span class="m">300</span>
</span></span><span class="line"><span class="cl">      folder: /OBDC/vm/tanzu
</span></span><span class="line"><span class="cl">      memoryMiB: <span class="m">16384</span>
</span></span><span class="line"><span class="cl">      network:
</span></span><span class="line"><span class="cl">        devices:
</span></span><span class="line"><span class="cl">        - dhcp4: <span class="nb">false</span>    <span class="c1">#### 변경</span>
</span></span><span class="line"><span class="cl">          networkName: /OBDC/network/LS-TKGM01-WORKLOAD-10.253.127.x
</span></span><span class="line"><span class="cl">      numCPUs: <span class="m">4</span>
</span></span><span class="line"><span class="cl">      resourcePool: /OBDC/host/OBCLUSTER/Resources/dk-tanzu
</span></span><span class="line"><span class="cl">      server: vcsa01.vcf.local
</span></span><span class="line"><span class="cl">      storagePolicyName: k8s
</span></span><span class="line"><span class="cl">      template: /OBDC/vm/temp/photon-3-kube-v1.24.10+vmware.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl apply -f run2-worker.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>이렇게 구성을 하게 되면 준비는 다 된것이다. 이제 master, worker node의 template만 변경 하게 되면 된다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl patch md run2-md-0 --type &#39;json&#39; -p &#39;[{&#34;op&#34;:&#34;replace&#34;,&#34;path&#34;:&#34;/spec/template/spec/infrastructureRef/name&#34;,&#34;value&#34;:&#34;run2-worker01&#34;}]&#39; --dry-run=client -o yaml | kubectl apply -f -
</span></span><span class="line"><span class="cl">kubectl patch kcp run2-control-plane --type &#39;json&#39; -p &#39;[{&#34;op&#34;:&#34;replace&#34;,&#34;path&#34;:&#34;/spec/machineTemplate/infrastructureRef/name&#34;,&#34;value&#34;:&#34;run2-control-plane01&#34;}]&#39; --dry-run=client -o yaml | kubectl apply - f-
</span></span></code></pre></td></tr></table>
</div>
</div><p>이렇게 변경을 하게 되면 자동적으로 VM이 삭제 하고 재 생성 되는 것을 확인 할 수 있다.</p>
<p>그러면 IPPOOL에서 제대로 받아 오는지 확인을 해볼 수 있을 것이다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl describe ippools.ipam.metal3.io run2-pool
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Status:
</span></span><span class="line"><span class="cl">  Indexes:
</span></span><span class="line"><span class="cl">    run2:                        10.253.127.121
</span></span><span class="line"><span class="cl">    run2-control-plane-wnng6-0:  10.253.127.124
</span></span><span class="line"><span class="cl">    run2-worker-hcmw8-0:         10.253.127.120
</span></span><span class="line"><span class="cl">    run2-worker-sgbmb-0:         10.253.127.122
</span></span><span class="line"><span class="cl">    run2-worker-sjf5m-0:         10.253.127.123
</span></span></code></pre></td></tr></table>
</div>
</div><p>DHCP서버를 완전히 안사용하게 할 수는 없겠지만 이 방법으로 어느정도 DHCP서버를 대체 할 수 있지 않을까라는 조심스러운 생각을 해본다.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-05-24&nbsp;<a class="git-hash" href="https://github.com/huntedhappy/huntedhappy.github.io/commit/9a9105826491a6d4a63d9f92d591982ace58e053" target="_blank" title="commit by huntedhappy(huntedhappy@gmail.com) 9a9105826491a6d4a63d9f92d591982ace58e053: rebuilding site Wed May 24 02:19:39     2023">
                                    <i class="fas fa-hashtag fa-fw"></i>9a91058</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/tanzu-ipam/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://huntedhappy.github.io/tanzu-ipam/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Share on Blogger" data-sharer="blogger" data-url="https://huntedhappy.github.io/tanzu-ipam/" data-title="The Documentation IPAM on TANZU" data-description="IPAM on TANZU"><i class="fab fa-blogger fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/tanzu/">tanzu</a>,&nbsp;<a href="/tags/k8s/">k8s</a>,&nbsp;<a href="/tags/ipam/">ipam</a>,&nbsp;<a href="/tags/devops/">devops</a>,&nbsp;<a href="/tags/dk/">dk</a>,&nbsp;<a href="/tags/dokyung/">dokyung</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/tmc/" class="prev" rel="prev" title="The Dcoumentation TMC"><i class="fas fa-angle-left fa-fw"></i>The Dcoumentation TMC</a></div>
</div>
<div id="comments"><div id="utterances"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">Utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021-12-29 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://huntedhappy.tistory.com" target="_blank">Dokyung</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/twemoji/twemoji.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"comments","lightTheme":"github-light","repo":"huntedhappy/comments"}},"data":{"id-1":"Dokyung's DevOoOps","id-2":"Dokyung's DevOoOps"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.en","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"},"twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', '216068312', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=216068312" async></script></body>
</html>
