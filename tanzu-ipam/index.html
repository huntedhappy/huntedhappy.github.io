<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>The Documentation IPAM on TANZU - Dokyung&#39;s DevOoOps</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="IPAM on TANZU" /><meta name="keywords" content='tanzu, k8s, ipam, devops, dk, dokyung' /><meta itemprop="name" content="The Documentation IPAM on TANZU">
<meta itemprop="description" content="IPAM on TANZU"><meta itemprop="datePublished" content="2023-05-24T01:42:56+09:00" />
<meta itemprop="dateModified" content="2023-09-17T08:19:26+09:00" />
<meta itemprop="wordCount" content="755"><meta itemprop="image" content="https://huntedhappy.github.io/tanzu-ipam/ipam.png" />
<meta itemprop="keywords" content="tanzu,k8s,ipam,devops,dk,dokyung," /><meta property="og:title" content="The Documentation IPAM on TANZU" />
<meta property="og:description" content="IPAM on TANZU" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://huntedhappy.github.io/tanzu-ipam/" /><meta property="og:image" content="https://huntedhappy.github.io/tanzu-ipam/ipam.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-24T01:42:56+09:00" />
<meta property="article:modified_time" content="2023-09-17T08:19:26+09:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://huntedhappy.github.io/tanzu-ipam/ipam.png" /><meta name="twitter:title" content="The Documentation IPAM on TANZU"/>
<meta name="twitter:description" content="IPAM on TANZU"/>
<meta name="application-name" content="Dokyung&#39;s DevOoOps">
<meta name="apple-mobile-web-app-title" content="Dokyung&#39;s DevOoOps"><meta name="theme-color" data-light="#ffffff" data-dark="#ffffff" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://huntedhappy.github.io/tanzu-ipam/" /><link rel="prev" href="https://huntedhappy.github.io/tmc/" /><link rel="next" href="https://huntedhappy.github.io/sops/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "The Documentation IPAM on TANZU",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/huntedhappy.github.io\/tanzu-ipam\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/huntedhappy.github.io\/tanzu-ipam\/ipam.png",
              "width":  1200 ,
              "height":  345 
            }],"genre": "posts","keywords": "tanzu, k8s, ipam, devops, dk, dokyung","wordcount":  755 ,
    "url": "https:\/\/huntedhappy.github.io\/tanzu-ipam\/","datePublished": "2023-05-24T01:42:56+09:00","dateModified": "2023-09-17T08:19:26+09:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Dokyung"
      },"description": "IPAM on TANZU"
  }
  </script></head>
  <body data-header-desktop="auto" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Dokyung&#39;s DevOoOps"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="typeit-header-desktop" class="typeit"></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >Tags</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/documentation/"
                
                
              >Docs</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              >About</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="https://github.com/huntedhappy"
                title="GitHub"
                rel="noopener noreferrer" target="_blank"
              ><i class='fab fa-github fa-fw'></i> </a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="Search titles or contents ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li><li class="menu-item language-switch">
            <span role="button" aria-label="Select Language" title="Select Language"><i class="fa-solid fa-language fa-fw" aria-hidden="true"></i></span>
            <ul class="sub-menu"><li class="menu-item">
                      <a href="/ko/tanzu-ipam/" class="menu-link" title="Korean">Korean</a>
                    </li><li class="menu-item">
                      <span class="menu-link text-secondary" title="한국어">한국어</span>
                    </li></ul>
          </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Dokyung&#39;s DevOoOps"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="typeit-header-title-mobile" class="typeit"></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="Search titles or contents ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              Cancel
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >Tags</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/documentation/"
                  
                  
                >Docs</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                >About</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="https://github.com/huntedhappy"
                  title="GitHub"
                  rel="noopener noreferrer" target="_blank"
                ><i class='fab fa-github fa-fw'></i> </a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span><span class="menu-system-item language-switch">
              <span role="button" aria-label="Select Language" title="Select Language">한국어<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i></span>
              <select class="language-select" onchange="location = this.value;"><option value="/ko/tanzu-ipam/">Korean</option><option value="/tanzu-ipam/" selected disabled>한국어</option></select>
            </span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>The Documentation IPAM on TANZU</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Dokyung</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/documentation/" class="post-category" title="Category - Documentation"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Documentation</a></span></div><div class="post-meta-line"><span title="published on 2023-05-24 01:42:56"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-05-24">2023-05-24</time></span>&nbsp;<span title="Updated on 2023-09-17 08:19:26"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2023-09-17">2023-09-17</time></span>&nbsp;<span title="755 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 800 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>4 minutes</span>&nbsp;</div>
    </div><div class="featured-image"><img loading="lazy" src="/tanzu-ipam/ipam.png" alt="/tanzu-ipam/ipam.png" data-title="IPAM on TANZU" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></div><div class="content" id="content"><h1 id="1--ipam-on-tanzu" class="heading-element">
  <a href="#1--ipam-on-tanzu" class="heading-mark"></a>1.  IPAM ON TANZU</h1><p>탄주는 기본적으로 DHCP 서버가 필요 하다. K8S 환경을 유지 하기 위해 VM의 라이프 사이클을 제공 하고 있기 때문이다. 그렇기 때문에 VM에 HANG이 걸리거나, 삭제가 되면 자동적으로 복구를 하게 된다. K8S에서 POD를 관리 하는 것처럼 탄주는 Master, Worker Node를 하나의 POD로 인식을 하게 설계를 한게 아닌가 싶다. 하지만 이런 자동화 시스템으로 인하여 STATIC하게 IP를 넣을 수도 없으며(DHCP서버를 통해 배포 후 IP를 변경 할 수 있겠지만 권장 하지 않는다.) 무조건적으로 DHCP 서버가 필요 하기 때문에 설치시 많은 어려움이 있을 수 있다. 또한 DHCP 서버를 운영 함으로 인해서 불필요한 자원을 사용하게 될 수도 있다.</p>
<p>지금 작성 하는 부분은 DHCP서버를 완전히 배제 할 수는 없다. 다만 메니저 클러스터를 배포 한 후 CLUSTER의 IP는 관리 클러스터에서 관리를 할 수 있게 설정을 할 수 있다. 두가지 방법이 있을 수 있는대 처음은 YTT를 구성함으로 인해서 처음부터 클러스터가 배포 될 경우 IP를 할당 받을 수 있게 할 수 도 있으며, 두번째로는 클러스터를 DHCP서버를 배포 후 IPAM을 사용하게 구성 할 수 있다.</p>
<p>당연히 YTT로 구성을 하여서 처음부터 배포를 하는 것이 권장을 할 것이다. 하지만 한편으로는 걱정도 된다. 이렇게 구성 함으로 인해서 업그레이드가 잘 될지.. (추후에 업그레이드도 진행을 해봐야 할 것이다&hellip;)</p>
<p>현재 작성하는 방법은 2번째 방법으로 진행 할 예정이다.
방법은 간단하다. 우선 metal3-io가 무엇을 하는지는 알지 못하지만 해당 github에서 제공을 받아 설치를 해볼 수 있을 것이다.</p>
<p>아래와 같이 GIT을 다운로드 받은 후 간단하게 실행을 해준다.</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone https://github.com/arbhoj/vsphere-ipam.git
</span></span><span class="line"><span class="cl">kubectl apply -f vsphere-ipam/metal3ipam/provider-components/infrastructure-components.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f vsphere-ipam/spectro-ipam-adapter/install.yaml</span></span></code></pre></td></tr></table>
</div>
</div><p>그리고 아래와 같이 환경 변수를 적용해도 되고, 그냥 입력을 해도 된다. 편한대로 설정을 해보자</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CLUSTER_NAME</span><span class="o">=</span>run2
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NETWORK_NAME</span><span class="o">=</span>LS-TKGM01-WORKLOAD-10.253.127.x <span class="c1">#This is the name of the network to be used in vSphere</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">START_IP</span><span class="o">=</span>10.253.127.120
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">END_IP</span><span class="o">=</span>10.253.127.130
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CIDR</span><span class="o">=</span><span class="m">24</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">GATEWAY</span><span class="o">=</span>10.253.127.1
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DNS_SERVER</span><span class="o">=</span>10.253.107.2</span></span></code></pre></td></tr></table>
</div>
</div><p>위와 같이 환경변수를 적용 후 ippol을 실행 해주자.</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: ipam.metal3.io/v1alpha1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: IPPool
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ${CLUSTER_NAME}-pool
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    cluster.x-k8s.io/network-name: ${NETWORK_NAME}
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  clusterName: ${CLUSTER_NAME}
</span></span></span><span class="line"><span class="cl"><span class="s">  namePrefix: ${CLUSTER_NAME}-prov
</span></span></span><span class="line"><span class="cl"><span class="s">  pools:
</span></span></span><span class="line"><span class="cl"><span class="s">    - start: ${START_IP}
</span></span></span><span class="line"><span class="cl"><span class="s">      end: ${END_IP}
</span></span></span><span class="line"><span class="cl"><span class="s">      prefix: ${CIDR}
</span></span></span><span class="line"><span class="cl"><span class="s">      gateway: ${GATEWAY}
</span></span></span><span class="line"><span class="cl"><span class="s">  prefix: 24
</span></span></span><span class="line"><span class="cl"><span class="s">  gateway: ${GATEWAY}
</span></span></span><span class="line"><span class="cl"><span class="s">  dnsServers: [${DNS_SERVER}]
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span></span></span></code></pre></td></tr></table>
</div>
</div><p>그리고 machine에다가 lables을 붙여주어야 한다. 지금 해도 되고 새로 생성 할 때 해도 된다.</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl label vspheremachinetemplates run2-control-plane cluster.x-k8s.io/ip-pool-name<span class="o">=</span>run2-pool
</span></span><span class="line"><span class="cl">kubectl label vspheremachinetemplates run2-worker cluster.x-k8s.io/ip-pool-name<span class="o">=</span>run2-pool</span></span></code></pre></td></tr></table>
</div>
</div><p>이렇게 구성을 하였다고 하더라도 실제적으로 vspheremachinetemplates 여기에 수정을 할 수가 없기 때문에 별도로 새로 생성을 해야 한다. 아마 이 부분은 vmsizing을 변경 할 때 많이 봤을 수도 있다. vmsizing은 이렇게 변경도 가능하지만 왠만하면 nodepool을 사용하여서 변경하는게 좋지 않을가 하는 생각을 잠시 한다.</p>
<p>아래와 같이 주석 처리 한부분을 추가 및 변경을 해준다.</p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl get VSphereMachineTemplate run2-control-plane -o yaml <span class="p">|</span> kubectl neat &gt; run2-control-plane.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vi run2-control-plan.yaml
</span></span><span class="line"><span class="cl">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
</span></span><span class="line"><span class="cl">kind: VSphereMachineTemplate
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    vmTemplateMoid: vm-134165
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    cluster.x-k8s.io/ip-pool-name: run2-pool   <span class="c1">## ippool이랑 name 일치 하는지 확인</span>
</span></span><span class="line"><span class="cl">  name: run2-control-plane01
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      cloneMode: fullClone
</span></span><span class="line"><span class="cl">      datacenter: /OBDC
</span></span><span class="line"><span class="cl">      datastore: /OBDC/datastore/vsanDatastore
</span></span><span class="line"><span class="cl">      diskGiB: <span class="m">300</span>
</span></span><span class="line"><span class="cl">      folder: /OBDC/vm/tanzu
</span></span><span class="line"><span class="cl">      memoryMiB: <span class="m">8192</span>
</span></span><span class="line"><span class="cl">      network:
</span></span><span class="line"><span class="cl">        devices:
</span></span><span class="line"><span class="cl">        - dhcp4: <span class="nb">false</span>   <span class="c1">#### 변경</span>
</span></span><span class="line"><span class="cl">          networkName: /OBDC/network/LS-TKGM01-WORKLOAD-10.253.127.x
</span></span><span class="line"><span class="cl">      numCPUs: <span class="m">4</span>
</span></span><span class="line"><span class="cl">      resourcePool: /OBDC/host/OBCLUSTER/Resources/dk-tanzu
</span></span><span class="line"><span class="cl">      server: vcsa01.vcf.local
</span></span><span class="line"><span class="cl">      storagePolicyName: k8s
</span></span><span class="line"><span class="cl">      template: /OBDC/vm/temp/photon-3-kube-v1.24.10+vmware.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl apply -f run2-control-plan.yaml</span></span></code></pre></td></tr></table>
</div>
</div><p>마찬가지로 worker노드도 템플릿을 생성 해준다.</p>
<div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get VSphereMachineTemplate run2-worker -o yaml <span class="p">|</span> kubectl neat &gt; run2-worker.yaml
</span></span><span class="line"><span class="cl">vi run2-worker.yaml
</span></span><span class="line"><span class="cl">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
</span></span><span class="line"><span class="cl">kind: VSphereMachineTemplate
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    vmTemplateMoid: vm-134165
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    cluster.x-k8s.io/ip-pool-name: run2-pool    <span class="c1">## ippool이랑 name 일치 하는지 확인</span>
</span></span><span class="line"><span class="cl">  name: run2-worker01
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      cloneMode: fullClone
</span></span><span class="line"><span class="cl">      datacenter: /OBDC
</span></span><span class="line"><span class="cl">      datastore: /OBDC/datastore/vsanDatastore
</span></span><span class="line"><span class="cl">      diskGiB: <span class="m">300</span>
</span></span><span class="line"><span class="cl">      folder: /OBDC/vm/tanzu
</span></span><span class="line"><span class="cl">      memoryMiB: <span class="m">16384</span>
</span></span><span class="line"><span class="cl">      network:
</span></span><span class="line"><span class="cl">        devices:
</span></span><span class="line"><span class="cl">        - dhcp4: <span class="nb">false</span>    <span class="c1">#### 변경</span>
</span></span><span class="line"><span class="cl">          networkName: /OBDC/network/LS-TKGM01-WORKLOAD-10.253.127.x
</span></span><span class="line"><span class="cl">      numCPUs: <span class="m">4</span>
</span></span><span class="line"><span class="cl">      resourcePool: /OBDC/host/OBCLUSTER/Resources/dk-tanzu
</span></span><span class="line"><span class="cl">      server: vcsa01.vcf.local
</span></span><span class="line"><span class="cl">      storagePolicyName: k8s
</span></span><span class="line"><span class="cl">      template: /OBDC/vm/temp/photon-3-kube-v1.24.10+vmware.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl apply -f run2-worker.yaml</span></span></code></pre></td></tr></table>
</div>
</div><p>이렇게 구성을 하게 되면 준비는 다 된것이다. 이제 master, worker node의 template만 변경 하게 되면 된다.</p>
<div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl patch md run2-md-0 --type &#39;json&#39; -p &#39;[{&#34;op&#34;:&#34;replace&#34;,&#34;path&#34;:&#34;/spec/template/spec/infrastructureRef/name&#34;,&#34;value&#34;:&#34;run2-worker01&#34;}]&#39; --dry-run=client -o yaml | kubectl apply -f -
</span></span><span class="line"><span class="cl">kubectl patch kcp run2-control-plane --type &#39;json&#39; -p &#39;[{&#34;op&#34;:&#34;replace&#34;,&#34;path&#34;:&#34;/spec/machineTemplate/infrastructureRef/name&#34;,&#34;value&#34;:&#34;run2-control-plane01&#34;}]&#39; --dry-run=client -o yaml | kubectl apply - f-</span></span></code></pre></td></tr></table>
</div>
</div><p>이렇게 변경을 하게 되면 자동적으로 VM이 삭제 하고 재 생성 되는 것을 확인 할 수 있다.</p>
<p>그러면 IPPOOL에서 제대로 받아 오는지 확인을 해볼 수 있을 것이다.</p>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl describe ippools.ipam.metal3.io run2-pool
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Status:
</span></span><span class="line"><span class="cl">  Indexes:
</span></span><span class="line"><span class="cl">    run2:                        10.253.127.121
</span></span><span class="line"><span class="cl">    run2-control-plane-wnng6-0:  10.253.127.124
</span></span><span class="line"><span class="cl">    run2-worker-hcmw8-0:         10.253.127.120
</span></span><span class="line"><span class="cl">    run2-worker-sgbmb-0:         10.253.127.122
</span></span><span class="line"><span class="cl">    run2-worker-sjf5m-0:         10.253.127.123</span></span></code></pre></td></tr></table>
</div>
</div><p>DHCP서버를 완전히 안사용하게 할 수는 없겠지만 이 방법으로 어느정도 DHCP서버를 대체 할 수 있지 않을까라는 조심스러운 생각을 해본다.</p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2023-09-17 08:19:26">Updated on 2023-09-17&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/tanzu-ipam/index.md" title="Read Markdown" class="link-to-markdown">Read Markdown</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://huntedhappy.github.io/tanzu-ipam/"><i class="fa-brands fa-linkedin fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Blogger" data-sharer="blogger" data-url="https://huntedhappy.github.io/tanzu-ipam/" data-title="The Documentation IPAM on TANZU" data-description="IPAM on TANZU"><i class="fa-brands fa-blogger fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/tanzu/" class="post-tag" title="Tags - tanzu">tanzu</a><a href="/tags/k8s/" class="post-tag" title="Tags - k8s">k8s</a><a href="/tags/ipam/" class="post-tag" title="Tags - ipam">ipam</a><a href="/tags/devops/" class="post-tag" title="Tags - devops">devops</a><a href="/tags/dk/" class="post-tag" title="Tags - dk">dk</a><a href="/tags/dokyung/" class="post-tag" title="Tags - dokyung">dokyung</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/tmc/" class="post-nav-item" rel="prev" title="The Dcoumentation TMC"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>The Dcoumentation TMC</a>
      <a href="/sops/" class="post-nav-item" rel="next" title="The Documentation Sops">The Documentation Sops<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="utterances" class="comment"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/" rel="external nofollow noopener noreferrer">Utterances</a>.
      </noscript></div></article>

  <aside class="toc" id="toc-auto" aria-label="Contents"></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.122.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.2-RC"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="View Comments"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">Theme FixIt works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/algoliasearch/algoliasearch-lite.umd.min.js" defer></script><script src="/lib/twemoji/twemoji.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":true,"expired":false,"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"comments","lightTheme":"github-light","repo":"huntedhappy/comments"}},"data":{"typeit-header-desktop":"Dokyung's DevOoOps","typeit-header-title-mobile":"Dokyung's DevOoOps"},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.en","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"},"twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"typeit-header-desktop":["typeit-header-desktop"],"typeit-header-title-mobile":["typeit-header-title-mobile"]},"duration":-1,"loop":false,"speed":100}};</script><script src="/js/theme.min.js" defer></script><script>
      window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
      gtag('config', '216068312', { 'anonymize_ip': true });
    </script><script src="https://www.googletagmanager.com/gtag/js?id=216068312" async></script></body>
</html>
