<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>The Documentation Sops - Dokyung&#39;s DevOoOps</title><meta name="Description" content="Install Tanzu Application Platform through Gitops with Secrets OPerationS (SOPS)"><meta property="og:title" content="The Documentation Sops" />
<meta property="og:description" content="Install Tanzu Application Platform through Gitops with Secrets OPerationS (SOPS)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://huntedhappy.github.io/sops/" /><meta property="og:image" content="https://huntedhappy.github.io/sops/index.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-20T19:22:18+09:00" />
<meta property="article:modified_time" content="2023-06-20T19:22:18+09:00" /><meta property="og:site_name" content="My cool site" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://huntedhappy.github.io/sops/index.png"/>
<meta name="twitter:title" content="The Documentation Sops"/>
<meta name="twitter:description" content="Install Tanzu Application Platform through Gitops with Secrets OPerationS (SOPS)"/>
<meta name="application-name" content="Dokyung&#39;s DevOoOps">
<meta name="apple-mobile-web-app-title" content="Dokyung&#39;s DevOoOps"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://huntedhappy.github.io/sops/" /><link rel="prev" href="https://huntedhappy.github.io/tanzu-ipam/" /><link rel="next" href="https://huntedhappy.github.io/tap-jenkins/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "The Documentation Sops",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/huntedhappy.github.io\/sops\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/huntedhappy.github.io\/sops\/index.png",
                            "width":  1265 ,
                            "height":  462 
                        }],"genre": "posts","keywords": "tanzu, k8s, devops, dk, dokyung","wordcount":  1095 ,
        "url": "https:\/\/huntedhappy.github.io\/sops\/","datePublished": "2023-06-20T19:22:18+09:00","dateModified": "2023-06-20T19:22:18+09:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Dokyung"
            },"description": "Install Tanzu Application Platform through Gitops with Secrets OPerationS (SOPS)"
    }
    </script></head>
    <body data-header-desktop="auto" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Dokyung&#39;s DevOoOps"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/categories/documentation/"> Docs </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/huntedhappy" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a><a href="javascript:void(0);" class="menu-item language" title="Select Language">
                    <i class="fa fa-globe" aria-hidden="true"></i>                      
                    <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/ko/sops/">Korean</option><option value="/sops/" selected>한국어</option></select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Dokyung&#39;s DevOoOps"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/categories/documentation/" title="">Docs</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/huntedhappy" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language">
                    <i class="fa fa-globe fa-fw" aria-hidden="true"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/ko/sops/">Korean</option><option value="/sops/" selected>한국어</option></select>
                </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">The Documentation Sops</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://huntedhappy.tistory.com" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Dokyung</a></span>&nbsp;<span class="post-category">included in <a href="/categories/documentation/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Documentation</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-06-20">2023-06-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1095 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;6 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/sops/index.png"
        data-srcset="/sops/index.png, /sops/index.png 1.5x, /sops/index.png 2x"
        data-sizes="auto"
        alt="/sops/index.png"
        title="Install Tanzu Application Platform through Gitops with Secrets OPerationS (SOPS)" /></div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#vmware-tanzu-sops-or-eso">VMware TANZU SOPS or ESO?</a></li>
    <li><a href="#prerequisites">Prerequisites</a></li>
    <li><a href="#relocate-images-to-a-registry">Relocate images to a registry</a>
      <ul>
        <li><a href="#create-a-new-git-repository">Create a new Git repository</a></li>
        <li><a href="#download-and-unpack-tanzu-gitops-reference-implementation-ri">Download and unpack Tanzu GitOps Reference Implementation (RI)</a></li>
        <li><a href="#create-cluster-configuration">Create cluster configuration</a></li>
        <li><a href="#preparing-sensitive-tanzu-application-platform-values">Preparing sensitive Tanzu Application Platform values</a></li>
        <li><a href="#generate-tanzu-application-platform-installation-and-tanzu-sync-configuration">Generate Tanzu Application Platform installation and Tanzu Sync configuration</a></li>
        <li><a href="#deploy-tanzu-sync">Deploy Tanzu Sync</a></li>
        <li><a href="#결과">결과</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="vmware-tanzu-sops-or-eso">VMware TANZU SOPS or ESO?</h2>
<p>TANZU APPLICATION PLATFORM을 설치 할 때 GITOPS로 두가지 방식으로 설치 할 수 있다. SOPS 및 ESO 방식으로 설치 할 수 있으며 현재는 베타 버전이며 프로덕션 환경에서는 권장 하지 않는다.</p>
<figure><img src="/images/sops/1-1.png"/><figcaption>
            <h4>warning</h4>
        </figcaption>
</figure>

<p>ESO의 경우 외부에 AWS Secrets Manager를 통해서 배포 할 수 있기 때문에 이 문서에서는 SOPS방식으로 배포를 할 예정이다.</p>
<p><figure><img src="/images/sops/1-2.png"/><figcaption>
            <h4>SOPS</h4>
        </figcaption>
</figure>

<figure><img src="/images/sops/1-3.png"/><figcaption>
            <h4>ESO</h4>
        </figcaption>
</figure>
</p>
<p><a href="https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/install-gitops-reference.html#choosing-sops-or-eso" target="_blank" rel="noopener noreffer "><i class="fas fa-link"></i> VMware TANZU GITOPS</a></p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>SOPS CLI to view and edit SOPS encrypted files. To install the SOPS CLI, see<a href="https://github.com/mozilla/sops/releases" target="_blank" rel="noopener noreffer "><i class="fas fa-link"></i> SOPS documentation</a>in GitHub.</li>
<li>Age CLI to create an ecryption key used to encrypt and decrypt sensitive data. To install the Age CLI, see<a href="https://github.com/FiloSottile/age#installation" target="_blank" rel="noopener noreffer "><i class="fas fa-link"></i> age documentation </a>in GitHub.</li>
<li>Completed the <a href="https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/prerequisites.html" target="_blank" rel="noopener noreffer "><i class="fas fa-link"></i> Prerequisites.</a></li>
<li><a href="https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/install-tanzu-cli.html" target="_blank" rel="noopener noreffer "><i class="fas fa-link"></i> Accepted Tanzu Application Platform EULA and installed Tanzu CLI</a> with any required plug-ins.</li>
<li>Installed <a href="https://docs.vmware.com/en/Cluster-Essentials-for-VMware-Tanzu/1.5/cluster-essentials/deploy.html" target="_blank" rel="noopener noreffer "><i class="fas fa-link"></i> Cluster Essentials for Tanzu.</a></li>
</ul>
<h2 id="relocate-images-to-a-registry">Relocate images to a registry</h2>
<p>탄주 네트워크에 있는 도커 이미지들을 내부에 내부 레지스트리에 저장 하는 것을 권장 한다. 탄주 네트워크 레지스트리를 사용 할 시 가동시간을 보장 하지 않기 때문이다.
지원되는 레지스트리는 Harbor, Azure Container Registry, Google Container Registry 및 Quay.io를 제공하고 있습니다. 설정 방법을 알아 보려면 다음 문서를 참조 하면 된다.</p>
<ul>
<li><a href="https://goharbor.io/docs/2.5.0/" target="_blank" rel="noopener noreffer "><i class="fas fa-link"></i> Harbor documentation</a></li>
<li><a href="https://cloud.google.com/container-registry/docs" target="_blank" rel="noopener noreffer "><i class="fas fa-link"></i> Google Container Registry documentation</a></li>
<li><a href="https://docs.projectquay.io/welcome.html" target="_blank" rel="noopener noreffer "><i class="fas fa-link"></i> Quay.io documentation</a></li>
</ul>
<ol>
<li>environment variables를 설정 한다.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">IMGPKG_REGISTRY_HOSTNAME_0</span><span class="o">=</span>registry.tanzu.vmware.com
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">IMGPKG_REGISTRY_USERNAME_0</span><span class="o">=</span>MY-TANZUNET-USERNAME
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">IMGPKG_REGISTRY_PASSWORD_0</span><span class="o">=</span>MY-TANZUNET-PASSWORD
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">IMGPKG_REGISTRY_HOSTNAME_1</span><span class="o">=</span>MY-REGISTRY
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">IMGPKG_REGISTRY_USERNAME_1</span><span class="o">=</span>MY-REGISTRY-USER
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">IMGPKG_REGISTRY_PASSWORD_1</span><span class="o">=</span>MY-REGISTRY-PASSWORD
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">INSTALL_REGISTRY_USERNAME</span><span class="o">=</span>MY-REGISTRY-USER
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">INSTALL_REGISTRY_PASSWORD</span><span class="o">=</span>MY-REGISTRY-PASSWORD
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">INSTALL_REGISTRY_HOSTNAME</span><span class="o">=</span>MY-REGISTRY
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TAP_VERSION</span><span class="o">=</span>VERSION-NUMBER
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">INSTALL_REPO</span><span class="o">=</span>TARGET-REPOSITORY
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li><a href="https://docs.vmware.com/en/Cluster-Essentials-for-VMware-Tanzu/1.5/cluster-essentials/deploy.html#optionally-install-clis-onto-your-path" target="_blank" rel="noopener noreffer "><i class="fas fa-link"></i> Install the Carvel tool imgpkg CLI.</a></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">## 이미지 버전 확인</span>
</span></span><span class="line"><span class="cl">imgpkg tag list -i registry.tanzu.vmware.com/tanzu-application-platform/tap-packages <span class="p">|</span> sort -V
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 이미지 버전을 내부 레지스트리로 복사</span>
</span></span><span class="line"><span class="cl">imgpkg copy -b registry.tanzu.vmware.com/tanzu-application-platform/tap-packages:<span class="si">${</span><span class="nv">TAP_VERSION</span><span class="si">}</span> --to-repo <span class="si">${</span><span class="nv">INSTALL_REGISTRY_HOSTNAME</span><span class="si">}</span>/<span class="si">${</span><span class="nv">INSTALL_REPO</span><span class="si">}</span>/tap-packages
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="create-a-new-git-repository">Create a new Git repository</h3>
<p>GIT에 프로젝트를 생성 한다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkdir -p <span class="nv">$HOME</span>/tap-gitops
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> <span class="nv">$HOME</span>/tap-gitops
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">git init
</span></span><span class="line"><span class="cl">git remote add origin git@github.com:my-organization/tap-gitops.git
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="download-and-unpack-tanzu-gitops-reference-implementation-ri">Download and unpack Tanzu GitOps Reference Implementation (RI)</h3>
<p>Tanzu Network에서 Tanzu GitOps Reference Implementation(RI)을 다운로드 받는다.
<figure><img src="/images/sops/1-4.png"/><figcaption>
            <h4>RI를 Download 받는다</h4>
        </figcaption>
</figure>
</p>
<p>다운로드 받은 RI를 내부 GIT에 업로드 한다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">tar xvf tanzu-gitops-ri-*.tgz -C <span class="nv">$HOME</span>/tap-gitops
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> <span class="nv">$HOME</span>/tap-gitops
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">git add . <span class="o">&amp;&amp;</span> git commit -m <span class="s2">&#34;Initialize Tanzu GitOps RI&#34;</span>
</span></span><span class="line"><span class="cl">git push -u origin
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="create-cluster-configuration">Create cluster configuration</h3>
<p>CLUSTER-NAME은 현재 내가 설정한 CLUSTER를 선택한다</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl config get-contexts 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> <span class="nv">$HOME</span>/tap-gitops
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./setup-repo.sh CLUSTER-NAME sops
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## Git에 업로드 </span>
</span></span><span class="line"><span class="cl">git add . <span class="o">&amp;&amp;</span> git commit -m <span class="s2">&#34;Add full-tap-cluster&#34;</span>
</span></span><span class="line"><span class="cl">git push
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="preparing-sensitive-tanzu-application-platform-values">Preparing sensitive Tanzu Application Platform values</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkdir -p <span class="nv">$HOME</span>/tmp-enc
</span></span><span class="line"><span class="cl">chmod <span class="m">700</span> <span class="nv">$HOME</span>/tmp-enc
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> <span class="nv">$HOME</span>/tmp-enc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">age-keygen -o key.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat key.txt
</span></span><span class="line"><span class="cl"><span class="c1"># created: 2023-02-08T10:55:35-07:00</span>
</span></span><span class="line"><span class="cl"><span class="c1"># public key: age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p</span>
</span></span><span class="line"><span class="cl">AGE-SECRET-KEY-my-secret-key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 아래 내용을 채워 준다.</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 만약에 멀티 클러스터를 구성 하고 싶으면 아래 내용을 분리 해준 후 각각 클러스터별로 실행 해주면 된다.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF &gt; $HOME/tmp-enc/tap-sensitive-values.yaml
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">tap_install:
</span></span></span><span class="line"><span class="cl"><span class="s">  sensitive_values:
</span></span></span><span class="line"><span class="cl"><span class="s">    shared:
</span></span></span><span class="line"><span class="cl"><span class="s">      ingress_domain: &#34;INGRESS-DOMAIN&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">      ingress_issuer: # Optional, can denote a cert-manager.io/v1/ClusterIssuer of your choice. Defaults to &#34;tap-ingress-selfsigned&#34;.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">      image_registry:
</span></span></span><span class="line"><span class="cl"><span class="s">        project_path: &#34;SERVER-NAME/REPO-NAME&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">        secret:
</span></span></span><span class="line"><span class="cl"><span class="s">          name: &#34;KP-DEFAULT-REPO-SECRET&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">          namespace: &#34;KP-DEFAULT-REPO-SECRET-NAMESPACE&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">      kubernetes_distribution: &#34;K8S-DISTRO&#34; # Only required if the distribution is OpenShift and must be used with the following kubernetes_version key.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">      kubernetes_version: &#34;K8S-VERSION&#34; # Required regardless of distribution when Kubernetes version is 1.25 or later.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">      ca_cert_data: | # To be passed if using custom certificates.
</span></span></span><span class="line"><span class="cl"><span class="s">          -----BEGIN CERTIFICATE-----
</span></span></span><span class="line"><span class="cl"><span class="s">          MIIFXzCCA0egAwIBAgIJAJYm37SFocjlMA0GCSqGSIb3DQEBDQUAMEY...
</span></span></span><span class="line"><span class="cl"><span class="s">          -----END CERTIFICATE-----
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    ceip_policy_disclosed: FALSE-OR-TRUE-VALUE # Installation fails if this is not set to true. Not a string.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    #The above keys are minimum numbers of entries needed in tap-values.yaml to get a functioning TAP Full profile installation.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    #Below are the keys which may have default values set, but can be overridden.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    profile: full # Can take iterate, build, run, view.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    supply_chain: basic # Can take testing, testing_scanning.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    ootb_supply_chain_basic: # Based on supply_chain set above, can be changed to ootb_supply_chain_testing, ootb_supply_chain_testing_scanning.
</span></span></span><span class="line"><span class="cl"><span class="s">      registry:
</span></span></span><span class="line"><span class="cl"><span class="s">        server: &#34;SERVER-NAME&#34; # Takes the value from the shared section by default, but can be overridden by setting a different value.
</span></span></span><span class="line"><span class="cl"><span class="s">        repository: &#34;REPO-NAME&#34; # Takes the value from the shared section by default, but can be overridden by setting a different value.
</span></span></span><span class="line"><span class="cl"><span class="s">      gitops:
</span></span></span><span class="line"><span class="cl"><span class="s">        ssh_secret: &#34;SSH-SECRET-KEY&#34; # Takes &#34;&#34; as value by default; but can be overridden by setting a different value.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    contour:
</span></span></span><span class="line"><span class="cl"><span class="s">      envoy:
</span></span></span><span class="line"><span class="cl"><span class="s">        service:
</span></span></span><span class="line"><span class="cl"><span class="s">          type: LoadBalancer # This is set by default, but can be overridden by setting a different value.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    buildservice:
</span></span></span><span class="line"><span class="cl"><span class="s">      # Takes the value from the shared section by default, but can be overridden by setting a different value.
</span></span></span><span class="line"><span class="cl"><span class="s">      kp_default_repository: &#34;KP-DEFAULT-REPO&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">      kp_default_repository_secret: # Takes the value from the shared section above by default, but can be overridden by setting a different value.
</span></span></span><span class="line"><span class="cl"><span class="s">        name: &#34;KP-DEFAULT-REPO-SECRET&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">        namespace: &#34;KP-DEFAULT-REPO-SECRET-NAMESPACE&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    tap_gui:
</span></span></span><span class="line"><span class="cl"><span class="s">      metadataStoreAutoconfiguration: true # Creates a service account, the Kubernetes control plane token and the requisite app_config block to enable communications between Tanzu Application Platform GUI and SCST - Store.
</span></span></span><span class="line"><span class="cl"><span class="s">      app_config:
</span></span></span><span class="line"><span class="cl"><span class="s">        catalog:
</span></span></span><span class="line"><span class="cl"><span class="s">          locations:
</span></span></span><span class="line"><span class="cl"><span class="s">            - type: url
</span></span></span><span class="line"><span class="cl"><span class="s">              target: https://GIT-CATALOG-URL/catalog-info.yaml
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    metadata_store:
</span></span></span><span class="line"><span class="cl"><span class="s">      ns_for_export_app_cert: &#34;MY-DEV-NAMESPACE&#34; # Verify this namespace is available within your cluster before initiating the Tanzu Application Platform installation.
</span></span></span><span class="line"><span class="cl"><span class="s">      app_service_type: ClusterIP # Defaults to LoadBalancer. If shared.ingress_domain is set earlier, this must be set to ClusterIP.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    scanning:
</span></span></span><span class="line"><span class="cl"><span class="s">      metadataStore:
</span></span></span><span class="line"><span class="cl"><span class="s">        url: &#34;&#34; # Configuration is moved, so set this string to empty.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    grype:
</span></span></span><span class="line"><span class="cl"><span class="s">      namespace: &#34;MY-DEV-NAMESPACE&#34; # Verify this namespace is available within your cluster before initiating the Tanzu Application Platform installation.
</span></span></span><span class="line"><span class="cl"><span class="s">      targetImagePullSecret: &#34;TARGET-REGISTRY-CREDENTIALS-SECRET&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">      # In a single cluster, the connection between the scanning pod and the metadata store happens inside the cluster and does not pass through ingress. This is automatically configured, you do not need to provide an ingress connection to the store.
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s">    policy:
</span></span></span><span class="line"><span class="cl"><span class="s">      tuf_enabled: false # By default, TUF initialization and keyless verification are deactivated.
</span></span></span><span class="line"><span class="cl"><span class="s">    tap_telemetry:
</span></span></span><span class="line"><span class="cl"><span class="s">      customer_entitlement_account_number: &#34;CUSTOMER-ENTITLEMENT-ACCOUNT-NUMBER&#34; # (Optional) Identify data for creating the Tanzu Application Platform usage reports.
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">SOPS_AGE_RECIPIENTS</span><span class="o">=</span><span class="k">$(</span>cat key.txt <span class="p">|</span> grep <span class="s2">&#34;# public key: &#34;</span> <span class="p">|</span> sed <span class="s1">&#39;s/# public key: //&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">sops --encrypt tap-sensitive-values.yaml &gt; tap-sensitive-values.sops.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mv tap-sensitive-values.sops.yaml <span class="nv">$HOME</span>/tap-gitops/clusters/full-tap-cluster/cluster-config/values/
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="generate-tanzu-application-platform-installation-and-tanzu-sync-configuration">Generate Tanzu Application Platform installation and Tanzu Sync configuration</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">INSTALL_REGISTRY_HOSTNAME</span><span class="o">=</span>MY-REGISTRY
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">INSTALL_REGISTRY_USERNAME</span><span class="o">=</span>MY-REGISTRY-USER
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">INSTALL_REGISTRY_PASSWORD</span><span class="o">=</span>MY-REGISTRY-PASSWORD
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">GIT_SSH_PRIVATE_KEY</span><span class="o">=</span>PRIVATE-KEY
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">GIT_KNOWN_HOSTS</span><span class="o">=</span>KNOWN-HOST-LIST
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">SOPS_AGE_KEY</span><span class="o">=</span>AGE-KEY
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TAP_PKGR_REPO</span><span class="o">=</span>TAP-PACKAGE-OCI-REPOSITORY
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> <span class="nv">$HOME</span>/tap-gitops/clusters/full-tap-cluster
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./tanzu-sync/scripts/configure.sh
</span></span><span class="line"><span class="cl">git add cluster-config/ tanzu-sync/
</span></span><span class="line"><span class="cl">git commit -m <span class="s2">&#34;Configure install of TAP 1.5.0&#34;</span>
</span></span><span class="line"><span class="cl">git push
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="deploy-tanzu-sync">Deploy Tanzu Sync</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">cd</span> <span class="nv">$HOME</span>/tap-gitops/clusters/full-tap-cluster
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./tanzu-sync/scripts/deploy.sh
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="결과">결과</h3>
<p>완료가 되면 자동으로 모든게 다 설치가 되는 것을 확인 할 수 있지만.. 솔직히 불편하다.. 그냥 설치하는게 편한거 같은 느낌은..
아직 베타이기 때문일지 모른다.
<figure><img src="/images/sops/1-5.png"/><figcaption>
            <h4>Result</h4>
        </figcaption>
</figure>
</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-06-20</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/sops/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://huntedhappy.github.io/sops/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Blogger" data-sharer="blogger" data-url="https://huntedhappy.github.io/sops/" data-title="The Documentation Sops" data-description="Install Tanzu Application Platform through Gitops with Secrets OPerationS (SOPS)"><i class="fab fa-blogger fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/tanzu/">tanzu</a>,&nbsp;<a href="/tags/k8s/">k8s</a>,&nbsp;<a href="/tags/devops/">devops</a>,&nbsp;<a href="/tags/dk/">dk</a>,&nbsp;<a href="/tags/dokyung/">dokyung</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/tanzu-ipam/" class="prev" rel="prev" title="The Documentation IPAM on TANZU"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>The Documentation IPAM on TANZU</a>
            <a href="/tap-jenkins/" class="next" rel="next" title="The Documentation TAP &amp; JENKINS">The Documentation TAP & JENKINS<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="utterances" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://huntedhappy.tistory.com" target="_blank">Dokyung</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/twemoji/twemoji.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/index.umd.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"comments","lightTheme":"github-light","repo":"huntedhappy/comments"}},"data":{"id-1":"Dokyung's DevOoOps","id-2":"Dokyung's DevOoOps"},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.en","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"},"twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', '216068312', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=216068312" async></script></body>
</html>
